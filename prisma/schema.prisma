generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "payroll", "fx", "cpq", "crm", "docs", "ops", "finance"]
}

model Tenant {
  id              String           @id @default(cuid())
  slug            String           @unique
  name            String
  active          Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  admins          Admin[]
  auditLogs       AuditLog[]
  presentations   Presentation[]
  settings        Setting[]
  templates       Template[]
  webhookSessions WebhookSession[]
  roleTemplates   RoleTemplate[]
  aiChatConversations AiChatConversation[]
  aiChatMessages  AiChatMessage[]
  financeConfig   FinanceRendicionConfig?
  financePayments FinancePayment[]
  adminGroups     AdminGroup[]

  @@index([slug])
  @@index([active])
  @@schema("public")
}

model WebhookSession {
  id        String   @id @default(cuid())
  sessionId String   @unique
  zohoData  Json
  status    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([status])
  @@index([tenantId])
  @@index([tenantId, createdAt])
  @@schema("public")
}

model Template {
  id            String         @id @default(cuid())
  name          String
  slug          String         @unique
  description   String?
  type          String
  category      String?
  active        Boolean        @default(true)
  isDefault     Boolean        @default(false)
  thumbnailUrl  String?
  createdBy     String?
  lastEditedBy  String?
  usageCount    Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  tenantId      String
  presentations Presentation[]
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([slug])
  @@index([active])
  @@index([type])
  @@index([tenantId])
  @@index([tenantId, active])
  @@schema("public")
}

model Presentation {
  id               String             @id @default(cuid())
  uniqueId         String             @unique
  templateId       String
  clientData       Json
  renderedContent  Json?
  status           String             @default("draft")
  recipientEmail   String?
  recipientName    String?
  emailSentAt      DateTime?
  emailProvider    String?
  emailMessageId   String?
  whatsappSharedAt DateTime?
  whatsappNumber   String?
  viewCount        Int                @default(0)
  firstViewedAt    DateTime?
  lastViewedAt     DateTime?
  expiresAt        DateTime?
  notes            String?
  tags             String[]
  createdBy        String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  ccEmails         String[]           @default([])
  clickCount       Int                @default(0)
  deliveredAt      DateTime?
  firstOpenedAt    DateTime?
  lastClickedAt    DateTime?
  lastOpenedAt     DateTime?
  openCount        Int                @default(0)
  tenantId         String
  quoteId          String?            @map("quote_id") // Links to CpqQuote for document generation
  template         Template           @relation(fields: [templateId], references: [id])
  tenant           Tenant             @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  views            PresentationView[]

  @@index([uniqueId])
  @@index([status])
  @@index([createdAt])
  @@index([templateId])
  @@index([recipientEmail])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@schema("public")
}

model PresentationView {
  id             String       @id @default(cuid())
  presentationId String
  ipAddress      String?
  userAgent      String?
  country        String?
  city           String?
  device         String?
  browser        String?
  viewedAt       DateTime     @default(now())
  duration       Int?
  sessionId      String?
  presentation   Presentation @relation(fields: [presentationId], references: [id], onDelete: Cascade)

  @@index([presentationId])
  @@index([viewedAt])
  @@index([sessionId])
  @@schema("public")
}

model Admin {
  id              String        @id @default(cuid())
  email           String        @unique
  password        String
  name            String
  role            String        @default("admin")
  roleTemplateId  String?       @map("role_template_id")
  lastLoginAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  tenantId        String
  status          String        @default("active")
  invitedBy       String?
  invitedAt       DateTime?
  activatedAt     DateTime?
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  roleTemplate    RoleTemplate? @relation(fields: [roleTemplateId], references: [id], onDelete: SetNull)
  aiChatConversations AiChatConversation[]
  groupMemberships AdminGroupMembership[]

  @@index([email])
  @@index([status])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([roleTemplateId])
  @@schema("public")
}

model RoleTemplate {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  name        String
  slug        String
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  permissions Json     @db.JsonB
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  admins Admin[]

  @@unique([tenantId, slug], map: "uq_role_template_tenant_slug")
  @@index([tenantId], map: "idx_role_templates_tenant")
  @@map("role_templates")
  @@schema("public")
}

model AdminGroup {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  slug        String
  name        String
  description String?
  color       String   @default("#6B7280")
  isSystem    Boolean  @default(false) @map("is_system")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  memberships AdminGroupMembership[]
  approvalSteps OpsTicketTypeApprovalStep[]

  @@unique([tenantId, slug], map: "uq_admin_groups_tenant_slug")
  @@index([tenantId], map: "idx_admin_groups_tenant")
  @@map("admin_groups")
  @@schema("public")
}

model AdminGroupMembership {
  id        String   @id @default(cuid())
  groupId   String   @map("group_id")
  adminId   String   @map("admin_id")
  role      String   @default("member")
  joinedAt  DateTime @default(now()) @map("joined_at") @db.Timestamptz(6)

  group     AdminGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  admin     Admin      @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@unique([groupId, adminId], map: "uq_admin_group_memberships_group_admin")
  @@index([groupId], map: "idx_admin_group_memberships_group")
  @@index([adminId], map: "idx_admin_group_memberships_admin")
  @@map("admin_group_memberships")
  @@schema("public")
}

model UserInvitation {
  id         String    @id @default(cuid())
  email      String
  role       String
  tenantId   String
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  revokedAt  DateTime?
  invitedBy  String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([token])
  @@index([email])
  @@index([tenantId])
  @@index([expiresAt])
  @@index([tenantId, email])
  @@schema("public")
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  email     String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@schema("public")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  userEmail String?
  action    String
  entity    String
  entityId  String?
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@index([tenantId])
  @@schema("public")
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  type      String
  category  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  @@index([key])
  @@index([category])
  @@index([tenantId])
  @@schema("public")
}

model AiChatConversation {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  title     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     Admin           @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages AiChatMessage[]

  @@index([tenantId, userId], map: "idx_ai_chat_conv_tenant_user")
  @@index([updatedAt], map: "idx_ai_chat_conv_updated_at")
  @@schema("public")
}

model AiChatMessage {
  id             String   @id @default(cuid())
  conversationId String   @map("conversation_id")
  tenantId       String   @map("tenant_id")
  role           String
  content        String   @db.Text
  metadata       Json?    @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at")

  conversation AiChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  tenant       Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt], map: "idx_ai_chat_msg_conv_created")
  @@index([tenantId], map: "idx_ai_chat_msg_tenant")
  @@schema("public")
}

model AiDocChunk {
  id          String   @id @default(cuid())
  sourcePath  String   @map("source_path")
  section     String
  content     String   @db.Text
  contentHash String   @unique @map("content_hash")
  embedding   Unsupported("vector(1536)")?
  tokenCount  Int      @default(0) @map("token_count")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([sourcePath], map: "idx_ai_doc_chunk_source")
  @@schema("public")
}

// ============================================
// FX MODULE (Financial Rates)
// ============================================

model FxUfRate {
  date      DateTime @id @db.Date
  value     Decimal  @db.Decimal(10, 2)
  fetchedAt DateTime @default(now()) @map("fetched_at") @db.Timestamptz(6)
  source    String?  @default("SBIF")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([date(sort: Desc)], map: "idx_uf_rates_date_desc")
  @@index([fetchedAt(sort: Desc)], map: "idx_uf_rates_fetched")
  @@map("uf_rates")
  @@schema("fx")
}

model FxUtmRate {
  month     DateTime @id @db.Date
  value     Decimal  @db.Decimal(10, 2)
  fetchedAt DateTime @default(now()) @map("fetched_at") @db.Timestamptz(6)
  source    String?  @default("SII")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([month(sort: Desc)], map: "idx_utm_rates_month_desc")
  @@index([fetchedAt(sort: Desc)], map: "idx_utm_rates_fetched")
  @@map("utm_rates")
  @@schema("fx")
}

// ============================================
// PAYROLL MODULE
// ============================================

model PayrollParameterVersion {
  id             String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name           String
  description    String?
  effectiveFrom  DateTime @map("effective_from") @db.Date
  effectiveUntil DateTime? @map("effective_until") @db.Date
  data           Json     @db.JsonB
  isActive       Boolean  @default(false) @map("is_active")
  createdBy      String?  @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  simulations PayrollSimulation[]

  @@index([effectiveFrom(sort: Desc)], map: "idx_param_versions_effective")
  @@index([isActive], map: "idx_param_versions_active")
  @@index([effectiveFrom, effectiveUntil], map: "idx_param_versions_dates")
  @@map("parameter_versions")
  @@schema("payroll")
}

model PayrollAssumption {
  id                       String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                     String
  description              String?
  vacationProvisionPct     Decimal  @default(0.0833) @map("vacation_provision_pct") @db.Decimal(5, 4)
  severanceProvisionPct    Decimal  @default(0.0000) @map("severance_provision_pct") @db.Decimal(5, 4)
  holidayBonusPct          Decimal  @default(0.0000) @map("holiday_bonus_pct") @db.Decimal(5, 4)
  christmasBonusPct        Decimal  @default(0.0000) @map("christmas_bonus_pct") @db.Decimal(5, 4)
  workInjuryBasicRate      Decimal? @map("work_injury_basic_rate") @db.Decimal(6, 5)
  workInjuryAdditionalRate Decimal? @map("work_injury_additional_rate") @db.Decimal(6, 5)
  workInjuryExtraRate      Decimal? @map("work_injury_extra_rate") @db.Decimal(6, 5)
  workInjuryTotalRate      Decimal? @map("work_injury_total_rate") @db.Decimal(6, 5)
  workInjuryRiskLevel      String   @default("medium") @map("work_injury_risk_level")
  isDefault                Boolean  @default(false) @map("is_default")
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  simulations PayrollSimulation[]

  @@index([isDefault], map: "idx_assumptions_default")
  @@map("assumptions")
  @@schema("payroll")
}

model PayrollSimulation {
  id                  String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  simulationType      String   @map("simulation_type")
  paramsVersionId     String   @map("params_version_id") @db.Uuid
  assumptionsId       String?  @map("assumptions_id") @db.Uuid
  inputs              Json     @db.JsonB
  results             Json     @db.JsonB
  parametersSnapshot  Json     @map("parameters_snapshot") @db.JsonB
  createdByUserId     String?  @map("created_by_user_id")
  tenantId            String?  @map("tenant_id")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  clientInfo          Json?    @map("client_info") @db.JsonB

  parameterVersion PayrollParameterVersion @relation(fields: [paramsVersionId], references: [id])
  assumptions      PayrollAssumption?      @relation(fields: [assumptionsId], references: [id])

  @@index([simulationType], map: "idx_simulations_type")
  @@index([createdAt(sort: Desc)], map: "idx_simulations_created_at")
  @@index([createdByUserId], map: "idx_simulations_user")
  @@index([tenantId], map: "idx_simulations_tenant")
  @@index([paramsVersionId], map: "idx_simulations_params_version")
  @@map("simulations")
  @@schema("payroll")
}

model PayrollSalaryComponent {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  code          String   @unique
  name          String
  description   String?
  componentType String   @map("component_type")
  isTaxable     Boolean  @default(true) @map("is_taxable")
  isTributable  Boolean  @default(true) @map("is_tributable")
  isActive      Boolean  @default(true) @map("is_active")
  displayOrder  Int?     @map("display_order")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([componentType], map: "idx_components_type")
  @@index([isActive], map: "idx_components_active")
  @@index([code], map: "idx_components_code")
  @@map("salary_components_catalog")
  @@schema("payroll")
}

// ============================================
// CPQ MODULE (Configure, Price, Quote)
// ============================================

model CpqQuote {
  id               String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId         String        @map("tenant_id")
  code             String        @unique @map("code")
  status           String        @default("draft")
  clientName       String?       @map("client_name")
  validUntil       DateTime?     @map("valid_until") @db.Date
  notes            String?
  totalPositions   Int           @default(0) @map("total_positions")
  totalGuards      Int           @default(0) @map("total_guards")
  monthlyCost      Decimal       @default(0) @map("monthly_cost") @db.Decimal(12, 2)
  // CRM context (optional - a quote can exist without CRM)
  accountId        String?       @map("account_id") @db.Uuid
  contactId        String?       @map("contact_id") @db.Uuid
  dealId           String?       @map("deal_id") @db.Uuid
  installationId   String?       @map("installation_id") @db.Uuid
  // Currency & AI
  currency         String        @default("CLP") // "CLP" | "UF"
  aiDescription    String?       @map("ai_description")
  serviceDetail    String?       @map("service_detail")
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  positions        CpqPosition[]
  parameters       CpqQuoteParameters?
  uniformItems     CpqQuoteUniformItem[]
  examItems        CpqQuoteExamItem[]
  costItems        CpqQuoteCostItem[]
  meals            CpqQuoteMeal[]
  vehicles         CpqQuoteVehicle[]
  infrastructure   CpqQuoteInfrastructure[]
  installation     CrmInstallation? @relation(fields: [installationId], references: [id], onDelete: SetNull)

  @@index([tenantId], map: "idx_cpq_quotes_tenant")
  @@index([status], map: "idx_cpq_quotes_status")
  @@index([createdAt(sort: Desc)], map: "idx_cpq_quotes_created_desc")
  @@index([accountId], map: "idx_cpq_quotes_account")
  @@index([dealId], map: "idx_cpq_quotes_deal")
  @@index([installationId], map: "idx_cpq_quotes_installation")
  @@map("quotes")
  @@schema("cpq")
}

model CpqPosition {
  id                  String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId             String   @map("quote_id") @db.Uuid
  puestoTrabajoId     String   @map("puesto_trabajo_id") @db.Uuid
  customName          String?  @map("custom_name")
  description         String?
  weekdays            String[] @map("weekdays")
  startTime           String   @map("start_time")
  endTime             String   @map("end_time")
  numGuards           Int      @default(1) @map("num_guards")
  cargoId             String   @map("cargo_id") @db.Uuid
  rolId               String   @map("rol_id") @db.Uuid
  baseSalary          Decimal  @map("base_salary") @db.Decimal(12, 2)
  afpName             String   @default("modelo") @map("afp_name")
  healthSystem        String   @default("fonasa") @map("health_system")
  healthPlanPct       Decimal? @map("health_plan_pct") @db.Decimal(5, 4)
  employerCost        Decimal  @map("employer_cost") @db.Decimal(12, 2)
  netSalary           Decimal? @map("net_salary") @db.Decimal(12, 2)
  monthlyPositionCost Decimal  @default(0) @map("monthly_position_cost") @db.Decimal(12, 2)
  payrollSnapshot     Json?    @map("payroll_snapshot") @db.JsonB
  payrollVersionId    String?  @map("payroll_version_id") @db.Uuid
  calculatedAt        DateTime? @map("calculated_at") @db.Timestamptz(6)
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quote         CpqQuote        @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  puestoTrabajo CpqPuestoTrabajo @relation(fields: [puestoTrabajoId], references: [id])
  cargo         CpqCargo        @relation(fields: [cargoId], references: [id])
  rol           CpqRol          @relation(fields: [rolId], references: [id])

  @@index([quoteId], map: "idx_cpq_positions_quote")
  @@index([puestoTrabajoId], map: "idx_cpq_positions_puesto")
  @@index([cargoId], map: "idx_cpq_positions_cargo")
  @@index([rolId], map: "idx_cpq_positions_rol")
  @@map("positions")
  @@schema("cpq")
}

model CpqPuestoTrabajo {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String   @unique
  colorHex    String?  @map("color_hex")
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  positions      CpqPosition[]
  opsPuestos     OpsPuestoOperativo[]

  @@index([active], map: "idx_cpq_puestos_active")
  @@map("puestos_trabajo")
  @@schema("cpq")
}

model CpqCargo {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String   @unique
  description String?
  colorHex    String?  @map("color_hex")
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  positions      CpqPosition[]
  opsPuestos     OpsPuestoOperativo[]

  @@index([active], map: "idx_cpq_cargos_active")
  @@map("cargos")
  @@schema("cpq")
}

model CpqRol {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String   @unique
  description String?
  colorHex    String?  @map("color_hex")
  patternWork Int?     @map("pattern_work")
  patternOff  Int?     @map("pattern_off")
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  positions      CpqPosition[]
  opsPuestos     OpsPuestoOperativo[]

  @@index([active], map: "idx_cpq_roles_active")
  @@map("roles")
  @@schema("cpq")
}

model CpqCatalogItem {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId          String?  @map("tenant_id")
  type              String
  name              String
  unit              String
  basePrice         Decimal  @default(0) @map("base_price") @db.Decimal(12, 2)
  isDefault         Boolean  @default(false) @map("is_default")
  defaultVisibility String   @default("visible") @map("default_visibility")
  active            Boolean  @default(true)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  uniformSelections CpqQuoteUniformItem[]
  examSelections    CpqQuoteExamItem[]
  costItems         CpqQuoteCostItem[]

  @@index([type], map: "idx_cpq_catalog_type")
  @@index([active], map: "idx_cpq_catalog_active")
  @@index([tenantId], map: "idx_cpq_catalog_tenant")
  @@index([tenantId, type], map: "idx_cpq_catalog_tenant_type")
  @@map("catalog_items")
  @@schema("cpq")
}

model CpqQuoteParameters {
  id                     String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId                String   @unique @map("quote_id") @db.Uuid
  monthlyHoursStandard   Int      @default(180) @map("monthly_hours_standard")
  avgStayMonths          Int      @default(4) @map("avg_stay_months")
  uniformChangesPerYear  Int      @default(3) @map("uniform_changes_per_year")
  financialEnabled      Boolean  @default(false) @map("financial_enabled")
  financialRatePct       Decimal  @default(0) @map("financial_rate_pct") @db.Decimal(6, 4)
  salePriceBase          Decimal  @default(0) @map("sale_price_base") @db.Decimal(14, 2)
  salePriceMonthly       Decimal  @default(0) @map("sale_price_monthly") @db.Decimal(12, 2)
  policyEnabled          Boolean  @default(false) @map("policy_enabled")
  policyRatePct          Decimal  @default(0) @map("policy_rate_pct") @db.Decimal(6, 4)
  policyAdminRatePct     Decimal  @default(0) @map("policy_admin_rate_pct") @db.Decimal(6, 4)
  policyContractMonths   Int      @default(12) @map("policy_contract_months")
  policyContractPct      Decimal  @default(100) @map("policy_contract_pct") @db.Decimal(6, 2)
  contractMonths         Int      @default(12) @map("contract_months")
  contractAmount         Decimal  @default(0) @map("contract_amount") @db.Decimal(14, 2)
  marginPct              Decimal  @default(13) @map("margin_pct") @db.Decimal(6, 2)
  createdAt              DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quote CpqQuote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@map("quote_parameters")
  @@schema("cpq")
}

model CpqQuoteUniformItem {
  id               String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId          String   @map("quote_id") @db.Uuid
  catalogItemId    String   @map("catalog_item_id") @db.Uuid
  unitPriceOverride Decimal? @map("unit_price_override") @db.Decimal(12, 2)
  active           Boolean  @default(true)
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quote       CpqQuote       @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  catalogItem CpqCatalogItem @relation(fields: [catalogItemId], references: [id])

  @@index([quoteId], map: "idx_cpq_uniform_quote")
  @@index([catalogItemId], map: "idx_cpq_uniform_catalog")
  @@map("quote_uniform_items")
  @@schema("cpq")
}

model CpqQuoteExamItem {
  id               String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId          String   @map("quote_id") @db.Uuid
  catalogItemId    String   @map("catalog_item_id") @db.Uuid
  unitPriceOverride Decimal? @map("unit_price_override") @db.Decimal(12, 2)
  active           Boolean  @default(true)
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quote       CpqQuote       @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  catalogItem CpqCatalogItem @relation(fields: [catalogItemId], references: [id])

  @@index([quoteId], map: "idx_cpq_exam_quote")
  @@index([catalogItemId], map: "idx_cpq_exam_catalog")
  @@map("quote_exam_items")
  @@schema("cpq")
}

model CpqQuoteCostItem {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId           String   @map("quote_id") @db.Uuid
  catalogItemId     String   @map("catalog_item_id") @db.Uuid
  calcMode          String   @default("per_month") @map("calc_mode")
  quantity          Decimal  @default(1) @db.Decimal(12, 2)
  unitPriceOverride Decimal? @map("unit_price_override") @db.Decimal(12, 2)
  isEnabled         Boolean  @default(true) @map("is_enabled")
  visibility        String   @default("visible")
  notes             String?
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quote       CpqQuote       @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  catalogItem CpqCatalogItem @relation(fields: [catalogItemId], references: [id])

  @@index([quoteId], map: "idx_cpq_cost_quote")
  @@index([catalogItemId], map: "idx_cpq_cost_catalog")
  @@index([isEnabled], map: "idx_cpq_cost_enabled")
  @@map("quote_cost_items")
  @@schema("cpq")
}

model CpqQuoteMeal {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId       String   @map("quote_id") @db.Uuid
  mealType      String   @map("meal_type")
  mealsPerDay   Int      @default(0) @map("meals_per_day")
  daysOfService Int      @default(0) @map("days_of_service")
  priceOverride Decimal? @map("price_override") @db.Decimal(12, 2)
  isEnabled     Boolean  @default(true) @map("is_enabled")
  visibility    String   @default("visible")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quote CpqQuote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId], map: "idx_cpq_meals_quote")
  @@map("quote_meals")
  @@schema("cpq")
}

model CpqQuoteVehicle {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId           String   @map("quote_id") @db.Uuid
  vehiclesCount     Int      @default(1) @map("vehicles_count")
  rentMonthly       Decimal  @default(0) @map("rent_monthly") @db.Decimal(12, 2)
  kmPerDay          Decimal  @default(0) @map("km_per_day") @db.Decimal(10, 2)
  daysPerMonth      Int      @default(0) @map("days_per_month")
  kmPerLiter        Decimal  @default(0) @map("km_per_liter") @db.Decimal(10, 2)
  fuelPrice         Decimal  @default(0) @map("fuel_price") @db.Decimal(12, 2)
  maintenanceMonthly Decimal @default(0) @map("maintenance_monthly") @db.Decimal(12, 2)
  isEnabled         Boolean  @default(true) @map("is_enabled")
  visibility        String   @default("visible")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quote CpqQuote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId], map: "idx_cpq_vehicles_quote")
  @@map("quote_vehicles")
  @@schema("cpq")
}

model CpqQuoteInfrastructure {
  id                 String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId            String   @map("quote_id") @db.Uuid
  itemType           String   @map("item_type")
  quantity           Int      @default(1)
  rentMonthly        Decimal  @default(0) @map("rent_monthly") @db.Decimal(12, 2)
  hasFuel            Boolean  @default(false) @map("has_fuel")
  fuelLitersPerHour  Decimal  @default(0) @map("fuel_liters_per_hour") @db.Decimal(10, 2)
  fuelHoursPerDay    Decimal  @default(0) @map("fuel_hours_per_day") @db.Decimal(10, 2)
  fuelDaysPerMonth   Int      @default(0) @map("fuel_days_per_month")
  fuelPrice          Decimal  @default(0) @map("fuel_price") @db.Decimal(12, 2)
  isEnabled          Boolean  @default(true) @map("is_enabled")
  visibility         String   @default("visible")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quote CpqQuote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId], map: "idx_cpq_infra_quote")
  @@map("quote_infrastructure")
  @@schema("cpq")
}

// ============================================
// CRM MODULE (Leads, Accounts, Deals, Email)
// ============================================

model CrmLead {
  id                 String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId           String    @map("tenant_id")
  status             String    @default("pending")
  source             String?
  firstName          String?   @map("first_name")
  lastName           String?   @map("last_name")
  email              String?
  phone              String?
  companyName        String?   @map("company_name")
  notes              String?
  industry           String?
  address            String?
  commune            String?
  city               String?
  website            String?
  serviceType        String?   @map("service_type")
  metadata           Json?     @db.JsonB
  approvedAt         DateTime? @map("approved_at") @db.Timestamptz(6)
  approvedBy         String?   @map("approved_by")
  convertedAccountId String?   @map("converted_account_id") @db.Uuid
  convertedContactId String?   @map("converted_contact_id") @db.Uuid
  convertedDealId    String?   @map("converted_deal_id") @db.Uuid
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  leadInstallations CrmInstallation[]

  @@index([tenantId], map: "idx_crm_leads_tenant")
  @@index([status], map: "idx_crm_leads_status")
  @@index([createdAt(sort: Desc)], map: "idx_crm_leads_created_desc")
  @@map("leads")
  @@schema("crm")
}

model Notification {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  type      String   // "new_lead", "lead_approved", "quote_sent", etc.
  title     String
  message   String?
  data      Json?    @db.JsonB
  read      Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([tenantId], map: "idx_notifications_tenant")
  @@index([tenantId, read], map: "idx_notifications_tenant_read")
  @@index([createdAt(sort: Desc)], map: "idx_notifications_created_desc")
  @@map("notifications")
  @@schema("crm")
}

model CrmIndustry {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name      String   @unique
  order     Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([active], map: "idx_crm_industries_active")
  @@map("industries")
  @@schema("crm")
}

model CrmAccount {
  id                      String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId                String   @map("tenant_id")
  name                    String
  rut                     String?
  legalName              String?  @map("legal_name") // Razón social
  legalRepresentativeName String?  @map("legal_representative_name")
  legalRepresentativeRut  String?  @map("legal_representative_rut")
  industry                String?
  size                    String?
  segment                 String?
  ownerId                 String?  @map("owner_id")
  type                    String   @default("prospect") // legacy compat: "prospect" | "client"
  status                  String   @default("prospect") // canonical lifecycle: prospect | client_active | client_inactive
  isActive                Boolean  @default(false) @map("is_active") // legacy compat, derived from status
  website                 String?
  address                 String?
  commune                 String?
  notes                   String?
  startDate               DateTime? @map("start_date") @db.Date
  endDate                 DateTime? @map("end_date") @db.Date
  createdAt               DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  contacts      CrmContact[]
  deals         CrmDeal[]
  installations CrmInstallation[]

  @@index([tenantId], map: "idx_crm_accounts_tenant")
  @@index([status], map: "idx_crm_accounts_status")
  @@index([isActive], map: "idx_crm_accounts_is_active")
  @@index([tenantId, type], map: "idx_crm_accounts_type")
  @@index([createdAt(sort: Desc)], map: "idx_crm_accounts_created_desc")
  @@map("accounts")
  @@schema("crm")
}

model CrmInstallation {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  accountId String?  @map("account_id") @db.Uuid
  leadId    String?  @map("lead_id") @db.Uuid
  name      String
  address   String?
  city      String?
  commune   String?
  lat       Float?
  lng       Float?
  isActive  Boolean  @default(false) @map("is_active")
  geoRadiusM Int     @default(100) @map("geo_radius_m")
  marcacionCode String? @unique @map("marcacion_code") // código único 8 chars para URL/QR
  teMontoClp Decimal @default(0) @map("te_monto_clp") @db.Decimal(12, 2)
  notes     String?
  metadata  Json?    @db.JsonB // dotacion sugerida, datos extra
  nocturnoEnabled Boolean @default(true) @map("nocturno_enabled") // incluir en control nocturno
  startDate DateTime? @map("start_date") @db.Date
  endDate   DateTime? @map("end_date") @db.Date
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  account       CrmAccount?           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  lead          CrmLead?              @relation(fields: [leadId], references: [id], onDelete: SetNull)
  quotes        CpqQuote[]
  opsPuestos    OpsPuestoOperativo[]
  opsPautas     OpsPautaMensual[]
  opsAsistencias OpsAsistenciaDiaria[]
  opsTurnosExtra       OpsTurnoExtra[]
  opsAsignacionGuardias OpsAsignacionGuardia[] @relation("ops_asignacion_installation")
  opsMarcaciones       OpsMarcacion[]
  opsCheckpoints       OpsCheckpoint[]
  opsRondaTemplates    OpsRondaTemplate[]
  opsRondaAlertas      OpsAlertaRonda[]
  guardiasActuales     OpsGuardia[]           @relation("ops_guardia_current_installation")
  opsControlNocturnoInstalaciones OpsControlNocturnoInstalacion[]

  @@index([tenantId], map: "idx_crm_installations_tenant")
  @@index([accountId], map: "idx_crm_installations_account")
  @@index([isActive], map: "idx_crm_installations_is_active")
  @@index([leadId], map: "idx_crm_installations_lead")
  @@map("installations")
  @@schema("crm")
}

model CrmContact {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId   String   @map("tenant_id")
  accountId  String   @map("account_id") @db.Uuid
  firstName  String   @map("first_name")
  lastName   String   @map("last_name")
  email      String?
  phone      String?
  roleTitle  String?  @map("role_title")
  isPrimary  Boolean  @default(false) @map("is_primary")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  account      CrmAccount       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  deals        CrmDeal[]        @relation("crm_deal_primary_contact")
  dealContacts CrmDealContact[]

  @@index([tenantId], map: "idx_crm_contacts_tenant")
  @@index([accountId], map: "idx_crm_contacts_account")
  @@index([createdAt(sort: Desc)], map: "idx_crm_contacts_created_desc")
  @@map("contacts")
  @@schema("crm")
}

model CrmDealContact {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  dealId    String   @map("deal_id") @db.Uuid
  contactId String   @map("contact_id") @db.Uuid
  role      String   @default("participant") // primary, participant, decision_maker
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  deal    CrmDeal    @relation(fields: [dealId], references: [id], onDelete: Cascade)
  contact CrmContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([dealId, contactId], map: "uq_crm_deal_contact")
  @@index([dealId], map: "idx_crm_deal_contacts_deal")
  @@index([contactId], map: "idx_crm_deal_contacts_contact")
  @@map("deal_contacts")
  @@schema("crm")
}

model CrmPipelineStage {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId     String   @map("tenant_id")
  name         String
  order        Int
  color        String?
  isActive     Boolean  @default(true) @map("is_active")
  isClosedWon  Boolean  @default(false) @map("is_closed_won")
  isClosedLost Boolean  @default(false) @map("is_closed_lost")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  deals        CrmDeal[]
  historyFrom  CrmDealStageHistory[] @relation("crm_history_from_stage")
  historyTo    CrmDealStageHistory[] @relation("crm_history_to_stage")

  @@index([tenantId], map: "idx_crm_pipeline_tenant")
  @@index([isActive], map: "idx_crm_pipeline_active")
  @@index([order], map: "idx_crm_pipeline_order")
  @@unique([tenantId, name], map: "uq_crm_pipeline_tenant_name")
  @@map("pipeline_stages")
  @@schema("crm")
}

model CrmDeal {
  id                   String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId             String    @map("tenant_id")
  accountId            String    @map("account_id") @db.Uuid
  primaryContactId     String?   @map("primary_contact_id") @db.Uuid
  title                String
  amount               Decimal   @default(0) @db.Decimal(14, 2)
  stageId              String    @map("stage_id") @db.Uuid
  probability          Int       @default(0)
  expectedCloseDate    DateTime?  @map("expected_close_date") @db.Date
  status               String    @default("open")
  lostReason           String?   @map("lost_reason")
  // Campos adicionales migración Soho CRM
  proposalLink        String?   @map("proposal_link") // Link a propuesta PandaDoc
  proposalSentAt      DateTime? @map("proposal_sent_at") @db.Date
  dealType            String?   @map("deal_type") // newbusiness, Cotización, Wherex, Licitación
  notes               String?
  driveFolderLink     String?   @map("drive_folder_link")
  installationName    String?   @map("installation_name")
  technicalVisitDate  DateTime? @map("technical_visit_date") @db.Date
  service             String?
  street              String?
  address             String?
  city                String?
  commune             String?
  lat                 Float?
  lng                 Float?
  installationWebsite String?   @map("installation_website")
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  account        CrmAccount       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  primaryContact CrmContact?      @relation("crm_deal_primary_contact", fields: [primaryContactId], references: [id], onDelete: SetNull)
  stage          CrmPipelineStage @relation(fields: [stageId], references: [id])
  stageHistory   CrmDealStageHistory[]
  quotes         CrmDealQuote[]
  tasks          CrmTask[]
  followUpLogs   CrmFollowUpLog[]
  dealContacts   CrmDealContact[]

  @@index([tenantId], map: "idx_crm_deals_tenant")
  @@index([status], map: "idx_crm_deals_status")
  @@index([stageId], map: "idx_crm_deals_stage")
  @@index([accountId], map: "idx_crm_deals_account")
  @@index([createdAt(sort: Desc)], map: "idx_crm_deals_created_desc")
  @@map("deals")
  @@schema("crm")
}

model CrmDealStageHistory {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id")
  dealId      String   @map("deal_id") @db.Uuid
  fromStageId String?  @map("from_stage_id") @db.Uuid
  toStageId   String   @map("to_stage_id") @db.Uuid
  changedBy   String?  @map("changed_by")
  changedAt   DateTime @default(now()) @map("changed_at") @db.Timestamptz(6)

  deal      CrmDeal          @relation(fields: [dealId], references: [id], onDelete: Cascade)
  fromStage CrmPipelineStage? @relation("crm_history_from_stage", fields: [fromStageId], references: [id])
  toStage   CrmPipelineStage  @relation("crm_history_to_stage", fields: [toStageId], references: [id])

  @@index([tenantId], map: "idx_crm_deal_stage_tenant")
  @@index([dealId], map: "idx_crm_deal_stage_deal")
  @@index([changedAt(sort: Desc)], map: "idx_crm_deal_stage_changed_desc")
  @@map("deal_stage_history")
  @@schema("crm")
}

model CrmDealQuote {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  dealId    String   @map("deal_id") @db.Uuid
  quoteId   String   @map("quote_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  deal CrmDeal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_crm_deal_quotes_tenant")
  @@index([dealId], map: "idx_crm_deal_quotes_deal")
  @@index([quoteId], map: "idx_crm_deal_quotes_quote")
  @@unique([dealId, quoteId], map: "uq_crm_deal_quote")
  @@map("deal_quotes")
  @@schema("crm")
}

model CrmTask {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId   String   @map("tenant_id")
  dealId     String?  @map("deal_id") @db.Uuid
  leadId     String?  @map("lead_id") @db.Uuid
  title      String
  status     String   @default("open")
  type       String   @default("followup")
  dueAt      DateTime? @map("due_at") @db.Timestamptz(6)
  assignedTo String?  @map("assigned_to")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  deal CrmDeal? @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_crm_tasks_tenant")
  @@index([status], map: "idx_crm_tasks_status")
  @@index([dueAt], map: "idx_crm_tasks_due")
  @@index([dealId], map: "idx_crm_tasks_deal")
  @@map("tasks")
  @@schema("crm")
}

model CrmEmailAccount {
  id                   String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId             String   @map("tenant_id")
  userId               String   @map("user_id")
  provider             String
  email                String
  accessTokenEncrypted String?  @map("access_token_encrypted")
  refreshTokenEncrypted String? @map("refresh_token_encrypted")
  tokenExpiresAt       DateTime? @map("token_expires_at") @db.Timestamptz(6)
  status               String   @default("active")
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([tenantId], map: "idx_crm_email_accounts_tenant")
  @@index([userId], map: "idx_crm_email_accounts_user")
  @@index([provider], map: "idx_crm_email_accounts_provider")
  @@map("email_accounts")
  @@schema("crm")
}

model CrmEmailThread {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String   @map("tenant_id")
  accountId     String?  @map("account_id") @db.Uuid
  contactId     String?  @map("contact_id") @db.Uuid
  dealId        String?  @map("deal_id") @db.Uuid
  subject       String
  lastMessageAt DateTime? @map("last_message_at") @db.Timestamptz(6)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  messages CrmEmailMessage[]

  @@index([tenantId], map: "idx_crm_email_threads_tenant")
  @@index([accountId], map: "idx_crm_email_threads_account")
  @@index([dealId], map: "idx_crm_email_threads_deal")
  @@map("email_threads")
  @@schema("crm")
}

model CrmEmailMessage {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId          String   @map("tenant_id")
  threadId          String   @map("thread_id") @db.Uuid
  providerMessageId String?  @map("provider_message_id")
  direction         String   @default("out")
  fromEmail         String   @map("from_email")
  toEmails          String[] @map("to_emails")
  ccEmails          String[] @default([]) @map("cc_emails")
  bccEmails         String[] @default([]) @map("bcc_emails")
  subject           String
  htmlBody          String?  @map("html_body")
  textBody          String?  @map("text_body")
  sentAt            DateTime? @map("sent_at") @db.Timestamptz(6)
  receivedAt        DateTime? @map("received_at") @db.Timestamptz(6)
  createdBy         String?  @map("created_by")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // ── Tracking fields ──
  resendId        String?   @map("resend_id")
  status          String    @default("queued") @map("email_status") // queued, sent, delivered, opened, clicked, bounced, complained
  deliveredAt     DateTime? @map("delivered_at") @db.Timestamptz(6)
  firstOpenedAt   DateTime? @map("first_opened_at") @db.Timestamptz(6)
  lastOpenedAt    DateTime? @map("last_opened_at") @db.Timestamptz(6)
  openCount       Int       @default(0) @map("open_count")
  firstClickedAt  DateTime? @map("first_clicked_at") @db.Timestamptz(6)
  clickCount      Int       @default(0) @map("click_count")
  bouncedAt       DateTime? @map("bounced_at") @db.Timestamptz(6)
  bounceType      String?   @map("bounce_type")

  // ── References ──
  signatureId     String?   @map("signature_id") @db.Uuid
  followUpLogId   String?   @map("followup_log_id") @db.Uuid
  source          String    @default("manual") // manual, followup, gmail

  thread CrmEmailThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_crm_email_messages_tenant")
  @@index([threadId], map: "idx_crm_email_messages_thread")
  @@index([sentAt], map: "idx_crm_email_messages_sent")
  @@index([resendId], map: "idx_crm_email_messages_resend")
  @@index([followUpLogId], map: "idx_crm_email_messages_followup")
  @@map("email_messages")
  @@schema("crm")
}

model CrmEmailTemplate {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  name      String
  subject   String
  body      String
  scope     String   @default("global")
  stageId   String?  @map("stage_id") @db.Uuid
  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([tenantId], map: "idx_crm_email_templates_tenant")
  @@index([scope], map: "idx_crm_email_templates_scope")
  @@index([stageId], map: "idx_crm_email_templates_stage")
  @@map("email_templates")
  @@schema("crm")
}

model CrmFile {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id")
  fileName        String   @map("file_name")
  mimeType        String   @map("mime_type")
  size            Int
  storageProvider String   @map("storage_provider")
  storageKey      String   @map("storage_key")
  createdBy       String?  @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  links CrmFileLink[]

  @@index([tenantId], map: "idx_crm_files_tenant")
  @@index([createdAt(sort: Desc)], map: "idx_crm_files_created_desc")
  @@map("files")
  @@schema("crm")
}

model CrmFileLink {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId   String   @map("tenant_id")
  fileId     String   @map("file_id") @db.Uuid
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  file CrmFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_crm_file_links_tenant")
  @@index([fileId], map: "idx_crm_file_links_file")
  @@index([entityType, entityId], map: "idx_crm_file_links_entity")
  @@map("file_links")
  @@schema("crm")
}

model CrmCustomField {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId   String   @map("tenant_id")
  entityType String   @map("entity_type")
  name       String
  type       String
  options    Json?
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  values CrmCustomFieldValue[]

  @@index([tenantId], map: "idx_crm_custom_fields_tenant")
  @@index([entityType], map: "idx_crm_custom_fields_entity")
  @@map("custom_fields")
  @@schema("crm")
}

model CrmCustomFieldValue {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  fieldId   String   @map("field_id") @db.Uuid
  entityId  String   @map("entity_id")
  value     Json?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  field CrmCustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_crm_custom_values_tenant")
  @@index([fieldId], map: "idx_crm_custom_values_field")
  @@index([entityId], map: "idx_crm_custom_values_entity")
  @@map("custom_field_values")
  @@schema("crm")
}

model CrmHistoryLog {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId   String   @map("tenant_id")
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  action     String
  details    Json?
  createdBy  String?  @map("created_by")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([tenantId], map: "idx_crm_history_tenant")
  @@index([entityType, entityId], map: "idx_crm_history_entity")
  @@index([createdAt(sort: Desc)], map: "idx_crm_history_created_desc")
  @@map("history_logs")
  @@schema("crm")
}

// ── Notes (shared across modules) ──

model CrmNote {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId   String   @map("tenant_id")
  entityType String   @map("entity_type") // "account", "contact", "deal", "quote"
  entityId   String   @map("entity_id")
  content    String   @db.Text
  mentions   String[] @default([]) // Array of admin IDs mentioned with @
  createdBy  String   @map("created_by") // admin ID
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([tenantId], map: "idx_crm_notes_tenant")
  @@index([entityType, entityId], map: "idx_crm_notes_entity")
  @@index([createdAt(sort: Desc)], map: "idx_crm_notes_created_desc")
  @@map("notes")
  @@schema("crm")
}

// ── Follow-up configuration (per tenant) ──

model CrmFollowUpConfig {
  id                    String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId              String   @unique @map("tenant_id")
  firstFollowUpDays     Int      @default(3) @map("first_followup_days")
  secondFollowUpDays    Int      @default(7) @map("second_followup_days")
  firstEmailTemplateId  String?  @map("first_email_template_id") @db.Uuid
  secondEmailTemplateId String?  @map("second_email_template_id") @db.Uuid
  whatsappFirstEnabled  Boolean  @default(true) @map("whatsapp_first_enabled")
  whatsappSecondEnabled Boolean  @default(true) @map("whatsapp_second_enabled")
  autoAdvanceStage      Boolean  @default(true) @map("auto_advance_stage")
  pauseOnReply          Boolean  @default(true) @map("pause_on_reply")
  sendHour              Int      @default(9) @map("send_hour") // 0-23, hora local de envío
  isActive              Boolean  @default(true) @map("is_active")
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([tenantId], map: "idx_crm_followup_config_tenant")
  @@map("crm_followup_config")
  @@schema("crm")
}

model CrmFollowUpLog {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String    @map("tenant_id")
  dealId        String    @map("deal_id") @db.Uuid
  sequence      Int       // 1 = primer seguimiento, 2 = segundo
  status        String    @default("pending") // pending, sent, failed, cancelled, paused
  scheduledAt   DateTime  @map("scheduled_at") @db.Timestamptz(6)
  sentAt        DateTime? @map("sent_at") @db.Timestamptz(6)
  emailMessageId String?  @map("email_message_id") @db.Uuid
  templateId    String?   @map("template_id") @db.Uuid
  error         String?
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  deal CrmDeal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([tenantId, status], map: "idx_crm_followup_logs_tenant_status")
  @@index([scheduledAt], map: "idx_crm_followup_logs_scheduled")
  @@index([dealId], map: "idx_crm_followup_logs_deal")
  @@map("crm_followup_logs")
  @@schema("crm")
}

// ── WhatsApp Templates (per tenant, editable messages) ──

model CrmWhatsAppTemplate {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  slug      String   // "lead_commercial", "lead_client", "proposal_sent", "followup_first", "followup_second"
  name      String   // Human-readable label
  body      String   @db.Text // Template body with {token} placeholders
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, slug], map: "uq_crm_wa_template_tenant_slug")
  @@index([tenantId], map: "idx_crm_wa_templates_tenant")
  @@map("crm_whatsapp_templates")
  @@schema("crm")
}

// ── Email Signatures ──

model CrmEmailSignature {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id")
  userId      String?  @map("user_id")
  name        String
  content     Json     @db.JsonB // Tiptap JSON
  htmlContent String?  @map("html_content") // HTML renderizado para emails
  isDefault   Boolean  @default(false) @map("is_default")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([tenantId], map: "idx_crm_signatures_tenant")
  @@index([userId], map: "idx_crm_signatures_user")
  @@index([tenantId, isDefault], map: "idx_crm_signatures_default")
  @@map("email_signatures")
  @@schema("crm")
}

// ============================================
// OPS MODULE (Operaciones, TE, Personas)
// ============================================

model OpsPersona {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  rut       String?
  email     String?
  phone     String?
  phoneMobile String? @map("phone_mobile")
  addressFormatted String? @map("address_formatted")
  googlePlaceId String? @map("google_place_id")
  addressLine1 String? @map("address_line_1")
  commune   String?
  city      String?
  region    String?
  lat       Decimal? @db.Decimal(10, 7)
  lng       Decimal? @db.Decimal(10, 7)
  addressSource String? @default("google_places") @map("address_source")
  birthDate DateTime? @map("birth_date") @db.Date
  sex String?
  afp String?
  healthSystem String? @map("health_system")
  isapreName String? @map("isapre_name")
  isapreHasExtraPercent Boolean? @default(false) @map("isapre_has_extra_percent")
  isapreExtraPercent Decimal? @map("isapre_extra_percent") @db.Decimal(5, 2)
  hasMobilization Boolean? @default(false) @map("has_mobilization")
  status    String   @default("active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  guardia OpsGuardia?

  @@index([tenantId], map: "idx_ops_personas_tenant")
  @@index([status], map: "idx_ops_personas_status")
  @@index([rut], map: "idx_ops_personas_rut")
  @@map("personas")
  @@schema("ops")
}

model OpsGuardia {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String    @map("tenant_id")
  personaId       String    @unique @map("persona_id") @db.Uuid
  code            String?
  status          String    @default("active")
  lifecycleStatus String    @default("postulante") @map("lifecycle_status")
  hiredAt         DateTime? @map("hired_at") @db.Date
  terminatedAt    DateTime? @map("terminated_at") @db.Date
  terminationReason String? @map("termination_reason")
  isBlacklisted   Boolean   @default(false) @map("is_blacklisted")
  blacklistReason String?   @map("blacklist_reason")
  blacklistedAt   DateTime? @map("blacklisted_at") @db.Timestamptz(6)
  availableExtraShifts Boolean @default(false) @map("available_extra_shifts")
  marcacionPin    String?   @map("marcacion_pin") // bcrypt hash del PIN de 4-6 dígitos
  marcacionPinVisible String? @map("marcacion_pin_visible") // PIN activo visible en ficha para operación
  currentInstallationId String? @map("current_installation_id") @db.Uuid
  montoAnticipo   Int       @default(0) @map("monto_anticipo")
  recibeAnticipo  Boolean   @default(false) @map("recibe_anticipo")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  persona               OpsPersona              @relation(fields: [personaId], references: [id], onDelete: Cascade)
  currentInstallation   CrmInstallation?        @relation("ops_guardia_current_installation", fields: [currentInstallationId], references: [id], onDelete: SetNull)
  bankAccounts          OpsCuentaBancaria[]
  flags                 OpsGuardiaFlag[]
  comments              OpsComentarioGuardia[]
  documents             OpsDocumentoPersona[]
  historyEvents         OpsGuardiaHistory[]
  pautas                OpsPautaMensual[]      @relation("ops_pauta_guardia")
  asistenciasPlanificadas OpsAsistenciaDiaria[] @relation("ops_asistencia_planificada_guardia")
  asistenciasReales     OpsAsistenciaDiaria[]  @relation("ops_asistencia_real_guardia")
  asistenciasReemplazo  OpsAsistenciaDiaria[]  @relation("ops_asistencia_reemplazo_guardia")
  turnosExtra           OpsTurnoExtra[]        @relation("ops_turno_extra_guardia")
  asignaciones          OpsAsignacionGuardia[] @relation("ops_asignacion_guardia")
  seriesAsignadas       OpsSerieAsignacion[]   @relation("ops_serie_guardia")
  eventosRrhh           OpsEventoRrhh[]
  pagoItems             OpsPagoTeItem[]        @relation("ops_pago_item_guardia")
  marcaciones           OpsMarcacion[]
  rondaEjecuciones      OpsRondaEjecucion[]
  rondaMarcaciones      OpsMarcacionCheckpoint[]
  rondaIncidentes       OpsRondaIncidente[]
  controlNocturnoGuardias OpsControlNocturnoGuardia[]
  tickets                 OpsTicket[]

  @@unique([tenantId, code], map: "uq_ops_guardias_tenant_code")
  @@index([tenantId], map: "idx_ops_guardias_tenant")
  @@index([status], map: "idx_ops_guardias_status")
  @@index([isBlacklisted], map: "idx_ops_guardias_blacklist")
  @@index([currentInstallationId], map: "idx_ops_guardias_current_installation")
  @@map("guardias")
  @@schema("ops")
}

model OpsGuardiaFlag {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  guardiaId String   @map("guardia_id") @db.Uuid
  type      String
  label     String
  severity  String   @default("info")
  notes     String?
  active    Boolean  @default(true)
  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  guardia OpsGuardia @relation(fields: [guardiaId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_ops_guardia_flags_tenant")
  @@index([guardiaId], map: "idx_ops_guardia_flags_guardia")
  @@index([active], map: "idx_ops_guardia_flags_active")
  @@map("guardia_flags")
  @@schema("ops")
}

model OpsDocumentoPersona {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String    @map("tenant_id")
  guardiaId String    @map("guardia_id") @db.Uuid
  type      String
  fileUrl   String?   @map("file_url")
  status    String    @default("pending")
  issuedAt  DateTime? @map("issued_at") @db.Date
  expiresAt DateTime? @map("expires_at") @db.Date
  notes     String?
  validatedBy String?  @map("validated_by")
  validatedAt DateTime? @map("validated_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  guardia OpsGuardia @relation(fields: [guardiaId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_ops_docs_persona_tenant")
  @@index([guardiaId], map: "idx_ops_docs_persona_guardia")
  @@index([expiresAt], map: "idx_ops_docs_persona_expires")
  @@map("documentos_persona")
  @@schema("ops")
}

model OpsCuentaBancaria {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String   @map("tenant_id")
  guardiaId     String   @map("guardia_id") @db.Uuid
  bankCode      String?  @map("bank_code")
  bankName      String   @map("bank_name")
  accountType   String   @map("account_type")
  accountNumber String   @map("account_number")
  holderName    String   @map("holder_name")
  holderRut     String?  @map("holder_rut")
  isDefault     Boolean  @default(false) @map("is_default")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  guardia OpsGuardia @relation(fields: [guardiaId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_ops_cuentas_bancarias_tenant")
  @@index([guardiaId], map: "idx_ops_cuentas_bancarias_guardia")
  @@index([isDefault], map: "idx_ops_cuentas_bancarias_default")
  @@map("cuentas_bancarias")
  @@schema("ops")
}

model OpsGuardiaHistory {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String   @map("tenant_id")
  guardiaId     String   @map("guardia_id") @db.Uuid
  eventType     String   @map("event_type")
  previousValue Json?    @map("previous_value") @db.JsonB
  newValue      Json?    @map("new_value") @db.JsonB
  reason        String?
  createdBy     String?  @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  guardia OpsGuardia @relation(fields: [guardiaId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_ops_guardia_history_tenant")
  @@index([guardiaId], map: "idx_ops_guardia_history_guardia")
  @@index([eventType], map: "idx_ops_guardia_history_event_type")
  @@map("guardia_history")
  @@schema("ops")
}

model OpsComentarioGuardia {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  guardiaId String   @map("guardia_id") @db.Uuid
  comment   String   @db.Text
  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  guardia OpsGuardia @relation(fields: [guardiaId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_ops_comentarios_guardia_tenant")
  @@index([guardiaId], map: "idx_ops_comentarios_guardia_guardia")
  @@map("comentarios_guardia")
  @@schema("ops")
}

model OpsPuestoOperativo {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id")
  installationId  String   @map("installation_id") @db.Uuid
  name            String
  puestoTrabajoId String?  @map("puesto_trabajo_id") @db.Uuid
  cargoId         String?  @map("cargo_id") @db.Uuid
  rolId           String?  @map("rol_id") @db.Uuid
  shiftStart      String   @map("shift_start")
  shiftEnd        String   @map("shift_end")
  weekdays        String[] @default([])
  requiredGuards  Int      @default(1) @map("required_guards")
  baseSalary      Decimal? @map("base_salary") @db.Decimal(12, 2)
  teMontoClp      Decimal? @map("te_monto_clp") @db.Decimal(12, 2)
  active          Boolean  @default(true)
  activeFrom      DateTime? @map("active_from") @db.Date
  activeUntil     DateTime? @map("active_until") @db.Date
  createdBy       String?  @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  installation   CrmInstallation      @relation(fields: [installationId], references: [id], onDelete: Cascade)
  puestoTrabajo  CpqPuestoTrabajo?    @relation(fields: [puestoTrabajoId], references: [id], onDelete: SetNull)
  cargo          CpqCargo?            @relation(fields: [cargoId], references: [id], onDelete: SetNull)
  rol            CpqRol?              @relation(fields: [rolId], references: [id], onDelete: SetNull)
  asignacionGuardias OpsAsignacionGuardia[] @relation("ops_asignacion_puesto")
  pautas             OpsPautaMensual[]
  asistencias        OpsAsistenciaDiaria[]
  turnosExtra        OpsTurnoExtra[]
  series             OpsSerieAsignacion[]
  marcaciones        OpsMarcacion[]

  @@index([tenantId], map: "idx_ops_puestos_tenant")
  @@index([installationId], map: "idx_ops_puestos_installation")
  @@index([active], map: "idx_ops_puestos_active")
  @@map("puestos_operativos")
  @@schema("ops")
}

model OpsPautaMensual {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String    @map("tenant_id")
  installationId  String    @map("installation_id") @db.Uuid
  puestoId        String    @map("puesto_id") @db.Uuid
  slotNumber      Int       @default(1) @map("slot_number")
  date            DateTime  @db.Date
  plannedGuardiaId String?   @map("planned_guardia_id") @db.Uuid
  shiftCode       String?   @map("shift_code")
  status          String    @default("planificado")
  notes           String?
  createdBy       String?   @map("created_by")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  installation  CrmInstallation @relation(fields: [installationId], references: [id], onDelete: Cascade)
  puesto        OpsPuestoOperativo @relation(fields: [puestoId], references: [id], onDelete: Cascade)
  plannedGuardia OpsGuardia?      @relation("ops_pauta_guardia", fields: [plannedGuardiaId], references: [id], onDelete: SetNull)

  @@unique([puestoId, slotNumber, date], map: "uq_ops_pauta_puesto_slot_fecha")
  @@index([tenantId], map: "idx_ops_pauta_tenant")
  @@index([installationId, date], map: "idx_ops_pauta_installation_date")
  @@index([plannedGuardiaId], map: "idx_ops_pauta_guardia")
  @@map("pauta_mensual")
  @@schema("ops")
}

model OpsAsignacionGuardia {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String    @map("tenant_id")
  guardiaId       String    @map("guardia_id") @db.Uuid
  puestoId        String    @map("puesto_id") @db.Uuid
  slotNumber      Int       @map("slot_number")
  installationId  String    @map("installation_id") @db.Uuid
  startDate       DateTime  @map("start_date") @db.Date
  endDate         DateTime? @map("end_date") @db.Date
  isActive        Boolean   @default(true) @map("is_active")
  reason          String?
  createdBy       String?   @map("created_by")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  guardia      OpsGuardia         @relation("ops_asignacion_guardia", fields: [guardiaId], references: [id], onDelete: Restrict)
  puesto       OpsPuestoOperativo @relation("ops_asignacion_puesto", fields: [puestoId], references: [id], onDelete: Cascade)
  installation CrmInstallation    @relation("ops_asignacion_installation", fields: [installationId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_ops_asignacion_guardia_tenant")
  @@index([guardiaId], map: "idx_ops_asignacion_guardia_guardia")
  @@index([puestoId, slotNumber], map: "idx_ops_asignacion_guardia_puesto_slot")
  @@index([installationId], map: "idx_ops_asignacion_guardia_installation")
  @@index([isActive], map: "idx_ops_asignacion_guardia_active")
  @@map("asignacion_guardias")
  @@schema("ops")
}

model OpsSerieAsignacion {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String    @map("tenant_id")
  puestoId        String    @map("puesto_id") @db.Uuid
  slotNumber      Int       @map("slot_number")
  guardiaId       String?   @map("guardia_id") @db.Uuid
  patternCode     String    @map("pattern_code")
  patternWork     Int       @map("pattern_work")
  patternOff      Int       @map("pattern_off")
  startDate       DateTime  @map("start_date") @db.Date
  startPosition   Int       @default(1) @map("start_position")
  endDate         DateTime? @map("end_date") @db.Date
  isActive        Boolean   @default(true) @map("is_active")
  createdBy       String?   @map("created_by")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  puesto  OpsPuestoOperativo @relation(fields: [puestoId], references: [id], onDelete: Cascade)
  guardia OpsGuardia?        @relation("ops_serie_guardia", fields: [guardiaId], references: [id], onDelete: SetNull)

  @@index([tenantId], map: "idx_ops_serie_asig_tenant")
  @@index([puestoId, slotNumber], map: "idx_ops_serie_asig_puesto_slot")
  @@index([guardiaId], map: "idx_ops_serie_asig_guardia")
  @@map("serie_asignaciones")
  @@schema("ops")
}

model OpsEventoRrhh {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String    @map("tenant_id")
  guardiaId String?   @map("guardia_id") @db.Uuid
  date      DateTime  @db.Date
  type      String
  status    String    @default("approved")
  notes     String?
  createdBy String?   @map("created_by")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  guardia OpsGuardia? @relation(fields: [guardiaId], references: [id], onDelete: SetNull)

  @@index([tenantId], map: "idx_ops_eventos_rrhh_tenant")
  @@index([guardiaId], map: "idx_ops_eventos_rrhh_guardia")
  @@index([date], map: "idx_ops_eventos_rrhh_date")
  @@map("eventos_rrhh")
  @@schema("ops")
}

model OpsAsistenciaDiaria {
  id                 String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId           String    @map("tenant_id")
  installationId     String    @map("installation_id") @db.Uuid
  puestoId           String    @map("puesto_id") @db.Uuid
  slotNumber         Int       @default(1) @map("slot_number")
  date               DateTime  @db.Date
  plannedGuardiaId   String?   @map("planned_guardia_id") @db.Uuid
  actualGuardiaId    String?   @map("actual_guardia_id") @db.Uuid
  replacementGuardiaId String? @map("replacement_guardia_id") @db.Uuid
  attendanceStatus   String    @default("pendiente") @map("attendance_status")
  checkInAt          DateTime? @map("check_in_at") @db.Timestamptz(6)
  checkOutAt         DateTime? @map("check_out_at") @db.Timestamptz(6)
  notes              String?
  teGenerated        Boolean   @default(false) @map("te_generated")
  lockedAt           DateTime? @map("locked_at") @db.Timestamptz(6)
  lockedBy           String?   @map("locked_by")
  correctionReason   String?   @map("correction_reason")
  createdBy          String?   @map("created_by")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  installation      CrmInstallation   @relation(fields: [installationId], references: [id], onDelete: Cascade)
  puesto            OpsPuestoOperativo @relation(fields: [puestoId], references: [id], onDelete: Cascade)
  plannedGuardia    OpsGuardia?       @relation("ops_asistencia_planificada_guardia", fields: [plannedGuardiaId], references: [id], onDelete: SetNull)
  actualGuardia     OpsGuardia?       @relation("ops_asistencia_real_guardia", fields: [actualGuardiaId], references: [id], onDelete: SetNull)
  replacementGuardia OpsGuardia?      @relation("ops_asistencia_reemplazo_guardia", fields: [replacementGuardiaId], references: [id], onDelete: SetNull)
  turnosExtra       OpsTurnoExtra[]

  @@unique([puestoId, slotNumber, date], map: "uq_ops_asistencia_puesto_slot_fecha")
  @@index([tenantId], map: "idx_ops_asistencia_tenant")
  @@index([installationId, date], map: "idx_ops_asistencia_installation_date")
  @@index([attendanceStatus], map: "idx_ops_asistencia_status")
  @@map("asistencia_diaria")
  @@schema("ops")
}

model OpsTurnoExtra {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId       String    @map("tenant_id")
  asistenciaId   String?   @unique @map("asistencia_id") @db.Uuid
  installationId String    @map("installation_id") @db.Uuid
  puestoId       String?   @map("puesto_id") @db.Uuid
  guardiaId      String    @map("guardia_id") @db.Uuid
  date           DateTime  @db.Date
  status         String    @default("pending")
  tipo           String    @default("turno_extra") @map("tipo") // "turno_extra" | "hora_extra"
  isManual       Boolean   @default(false) @map("is_manual")
  horasExtra     Decimal?  @map("horas_extra") @db.Decimal(4, 1)
  amountClp      Decimal   @default(0) @map("amount_clp") @db.Decimal(12, 2)
  approvedBy     String?   @map("approved_by")
  approvedAt     DateTime? @map("approved_at") @db.Timestamptz(6)
  rejectedBy     String?   @map("rejected_by")
  rejectedAt     DateTime? @map("rejected_at") @db.Timestamptz(6)
  rejectionReason String?  @map("rejection_reason")
  paidAt         DateTime? @map("paid_at") @db.Timestamptz(6)
  createdBy      String?   @map("created_by")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  asistencia   OpsAsistenciaDiaria? @relation(fields: [asistenciaId], references: [id], onDelete: SetNull)
  installation CrmInstallation      @relation(fields: [installationId], references: [id], onDelete: Cascade)
  puesto       OpsPuestoOperativo?  @relation(fields: [puestoId], references: [id], onDelete: SetNull)
  guardia      OpsGuardia           @relation("ops_turno_extra_guardia", fields: [guardiaId], references: [id], onDelete: Restrict)
  paymentItems OpsPagoTeItem[]

  @@index([tenantId], map: "idx_ops_turnos_extra_tenant")
  @@index([status], map: "idx_ops_turnos_extra_status")
  @@index([date], map: "idx_ops_turnos_extra_date")
  @@index([guardiaId], map: "idx_ops_turnos_extra_guardia")
  @@index([installationId], map: "idx_ops_turnos_extra_installation")
  @@map("turnos_extra")
  @@schema("ops")
}

model OpsPagoTeLote {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId       String    @map("tenant_id")
  code           String    @unique
  weekStart      DateTime  @map("week_start") @db.Date
  weekEnd        DateTime  @map("week_end") @db.Date
  status         String    @default("draft")
  totalAmountClp Decimal   @default(0) @map("total_amount_clp") @db.Decimal(14, 2)
  createdBy      String?   @map("created_by")
  paidAt         DateTime? @map("paid_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  items OpsPagoTeItem[]

  @@index([tenantId], map: "idx_ops_pago_te_lotes_tenant")
  @@index([status], map: "idx_ops_pago_te_lotes_status")
  @@index([weekStart, weekEnd], map: "idx_ops_pago_te_lotes_week")
  @@map("pago_te_lotes")
  @@schema("ops")
}

model OpsPagoTeItem {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId     String    @map("tenant_id")
  loteId       String    @map("lote_id") @db.Uuid
  turnoExtraId String    @unique @map("turno_extra_id") @db.Uuid
  guardiaId    String    @map("guardia_id") @db.Uuid
  amountClp    Decimal   @default(0) @map("amount_clp") @db.Decimal(12, 2)
  status       String    @default("pending")
  paidAt       DateTime? @map("paid_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  lote       OpsPagoTeLote @relation(fields: [loteId], references: [id], onDelete: Cascade)
  turnoExtra OpsTurnoExtra @relation(fields: [turnoExtraId], references: [id], onDelete: Cascade)
  guardia    OpsGuardia    @relation("ops_pago_item_guardia", fields: [guardiaId], references: [id], onDelete: Restrict)

  @@index([tenantId], map: "idx_ops_pago_te_items_tenant")
  @@index([loteId], map: "idx_ops_pago_te_items_lote")
  @@index([guardiaId], map: "idx_ops_pago_te_items_guardia")
  @@index([status], map: "idx_ops_pago_te_items_status")
  @@map("pago_te_items")
  @@schema("ops")
}

// ============================================
// OPS — MARCACIÓN DIGITAL (Asistencia)
// ============================================

model OpsMarcacion {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id")
  guardiaId       String   @map("guardia_id") @db.Uuid
  installationId  String   @map("installation_id") @db.Uuid
  puestoId        String?  @map("puesto_id") @db.Uuid
  slotNumber      Int?     @map("slot_number")
  tipo            String   // "entrada" | "salida"
  timestamp       DateTime @default(now()) @db.Timestamptz(6)
  lat             Float?
  lng             Float?
  geoValidada     Boolean  @default(false) @map("geo_validada")
  geoDistanciaM   Float?   @map("geo_distancia_m") // distancia al centro de la instalación en metros
  metodoId        String   @default("rut_pin") @map("metodo_id") // método de identificación
  fotoEvidenciaUrl String? @map("foto_evidencia_url") // URL de la foto capturada al marcar (evidencia, no biométrica)
  ipAddress       String?  @map("ip_address")
  userAgent       String?  @map("user_agent")
  hashIntegridad  String   @map("hash_integridad") // SHA-256 del registro completo
  atrasoMinutos   Int?     @map("atraso_minutos") // minutos de atraso cuando tipo=entrada
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  guardia      OpsGuardia          @relation(fields: [guardiaId], references: [id])
  installation CrmInstallation     @relation(fields: [installationId], references: [id])
  puesto       OpsPuestoOperativo? @relation(fields: [puestoId], references: [id])

  @@index([tenantId], map: "idx_ops_marcaciones_tenant")
  @@index([guardiaId], map: "idx_ops_marcaciones_guardia")
  @@index([installationId, timestamp], map: "idx_ops_marcaciones_inst_ts")
  @@index([timestamp], map: "idx_ops_marcaciones_timestamp")
  @@map("marcaciones")
  @@schema("ops")
}

// ============================================
// OPS — CONTROL DE RONDAS DE SEGURIDAD
// ============================================

model OpsCheckpoint {
  id             String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId       String   @map("tenant_id")
  installationId String   @map("installation_id") @db.Uuid
  name           String
  description    String?
  qrCode         String   @map("qr_code")
  lat            Float?
  lng            Float?
  geoRadiusM     Int      @default(30) @map("geo_radius_m")
  isActive       Boolean  @default(true) @map("is_active")
  createdBy      String?  @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  installation    CrmInstallation        @relation(fields: [installationId], references: [id], onDelete: Cascade)
  rondaLinks      OpsRondaCheckpoint[]
  marcaciones     OpsMarcacionCheckpoint[]
  incidentes      OpsRondaIncidente[]

  @@unique([tenantId, qrCode], map: "uq_ops_checkpoint_tenant_qr")
  @@index([tenantId], map: "idx_ops_checkpoints_tenant")
  @@index([tenantId, installationId], map: "idx_ops_checkpoints_tenant_installation")
  @@index([installationId], map: "idx_ops_checkpoints_installation")
  @@index([isActive], map: "idx_ops_checkpoints_active")
  @@map("checkpoints")
  @@schema("ops")
}

model OpsRondaTemplate {
  id                  String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId            String   @map("tenant_id")
  installationId      String   @map("installation_id") @db.Uuid
  name                String
  description         String?
  orderMode           String   @default("flexible") @map("order_mode") // "strict" | "flexible"
  estimatedDurationMin Int?    @map("estimated_duration_min")
  isActive            Boolean  @default(true) @map("is_active")
  createdBy           String?  @map("created_by")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  installation CrmInstallation        @relation(fields: [installationId], references: [id], onDelete: Cascade)
  checkpoints  OpsRondaCheckpoint[]
  programaciones OpsRondaProgramacion[]
  ejecuciones  OpsRondaEjecucion[]
  incidentes   OpsRondaIncidente[]

  @@index([tenantId], map: "idx_ops_ronda_templates_tenant")
  @@index([tenantId, installationId], map: "idx_ops_ronda_templates_tenant_installation")
  @@index([installationId], map: "idx_ops_ronda_templates_installation")
  @@index([isActive], map: "idx_ops_ronda_templates_active")
  @@map("ronda_templates")
  @@schema("ops")
}

model OpsRondaCheckpoint {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id")
  rondaTemplateId String   @map("ronda_template_id") @db.Uuid
  checkpointId    String   @map("checkpoint_id") @db.Uuid
  orderIndex      Int      @default(1) @map("order_index")
  isRequired      Boolean  @default(true) @map("is_required")
  maxTimeMinutes  Int?     @map("max_time_minutes")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  rondaTemplate OpsRondaTemplate @relation(fields: [rondaTemplateId], references: [id], onDelete: Cascade)
  checkpoint    OpsCheckpoint    @relation(fields: [checkpointId], references: [id], onDelete: Cascade)

  @@unique([rondaTemplateId, checkpointId], map: "uq_ops_ronda_checkpoint")
  @@index([tenantId], map: "idx_ops_ronda_checkpoints_tenant")
  @@index([rondaTemplateId], map: "idx_ops_ronda_checkpoints_template")
  @@index([checkpointId], map: "idx_ops_ronda_checkpoints_checkpoint")
  @@map("ronda_checkpoints")
  @@schema("ops")
}

model OpsRondaProgramacion {
  id               String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId         String   @map("tenant_id")
  rondaTemplateId  String   @map("ronda_template_id") @db.Uuid
  diasSemana       Json     @default("[]") @map("dias_semana") @db.JsonB
  horaInicio       String   @map("hora_inicio")
  horaFin          String   @map("hora_fin")
  frecuenciaMinutos Int     @default(120) @map("frecuencia_minutos")
  toleranciaMinutos Int     @default(10) @map("tolerancia_minutos")
  isActive         Boolean  @default(true) @map("is_active")
  createdBy        String?  @map("created_by")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  rondaTemplate OpsRondaTemplate  @relation(fields: [rondaTemplateId], references: [id], onDelete: Cascade)
  ejecuciones   OpsRondaEjecucion[]

  @@index([tenantId], map: "idx_ops_ronda_programaciones_tenant")
  @@index([rondaTemplateId], map: "idx_ops_ronda_programaciones_template")
  @@index([isActive], map: "idx_ops_ronda_programaciones_active")
  @@map("ronda_programaciones")
  @@schema("ops")
}

model OpsRondaEjecucion {
  id                    String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId              String    @map("tenant_id")
  rondaTemplateId       String    @map("ronda_template_id") @db.Uuid
  programacionId        String?   @map("programacion_id") @db.Uuid
  guardiaId             String?   @map("guardia_id") @db.Uuid
  status                String    @default("pendiente") // "pendiente" | "en_curso" | "completada" | "incompleta" | "no_realizada"
  scheduledAt           DateTime  @map("scheduled_at") @db.Timestamptz(6)
  startedAt             DateTime? @map("started_at") @db.Timestamptz(6)
  completedAt           DateTime? @map("completed_at") @db.Timestamptz(6)
  checkpointsTotal      Int       @default(0) @map("checkpoints_total")
  checkpointsCompletados Int      @default(0) @map("checkpoints_completados")
  porcentajeCompletado  Float     @default(0) @map("porcentaje_completado")
  trustScore            Int       @default(0) @map("trust_score")
  deviceInfo            Json?     @map("device_info") @db.JsonB
  alertas               Json?     @db.JsonB
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  rondaTemplate OpsRondaTemplate      @relation(fields: [rondaTemplateId], references: [id], onDelete: Cascade)
  programacion  OpsRondaProgramacion? @relation(fields: [programacionId], references: [id], onDelete: SetNull)
  guardia       OpsGuardia?           @relation(fields: [guardiaId], references: [id], onDelete: SetNull)
  marcaciones   OpsMarcacionCheckpoint[]
  alertasRows   OpsAlertaRonda[]
  incidentes    OpsRondaIncidente[]

  @@index([tenantId], map: "idx_ops_ronda_ejecuciones_tenant")
  @@index([rondaTemplateId], map: "idx_ops_ronda_ejecuciones_template")
  @@index([programacionId], map: "idx_ops_ronda_ejecuciones_programacion")
  @@index([guardiaId], map: "idx_ops_ronda_ejecuciones_guardia")
  @@index([scheduledAt], map: "idx_ops_ronda_ejecuciones_scheduled_at")
  @@index([status], map: "idx_ops_ronda_ejecuciones_status")
  @@map("ronda_ejecuciones")
  @@schema("ops")
}

model OpsMarcacionCheckpoint {
  id               String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId         String   @map("tenant_id")
  ejecucionId      String   @map("ejecucion_id") @db.Uuid
  checkpointId     String   @map("checkpoint_id") @db.Uuid
  guardiaId        String   @map("guardia_id") @db.Uuid
  timestamp        DateTime @default(now()) @db.Timestamptz(6)
  lat              Float?
  lng              Float?
  geoValidada      Boolean  @default(false) @map("geo_validada")
  geoDistanciaM    Float?   @map("geo_distancia_m")
  batteryLevel     Int?     @map("battery_level")
  motionData       Json?    @map("motion_data") @db.JsonB
  speedFromPrevKmh Float?   @map("speed_from_prev_kmh")
  timeFromPrevSec  Int?     @map("time_from_prev_sec")
  fotoEvidenciaUrl String?  @map("foto_evidencia_url")
  hashIntegridad   String   @map("hash_integridad")
  anomalias        Json?    @db.JsonB
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  ejecucion  OpsRondaEjecucion @relation(fields: [ejecucionId], references: [id], onDelete: Cascade)
  checkpoint OpsCheckpoint     @relation(fields: [checkpointId], references: [id], onDelete: Restrict)
  guardia    OpsGuardia        @relation(fields: [guardiaId], references: [id], onDelete: Restrict)

  @@index([tenantId], map: "idx_ops_marcacion_checkpoint_tenant")
  @@index([ejecucionId], map: "idx_ops_marcacion_checkpoint_ejecucion")
  @@index([checkpointId], map: "idx_ops_marcacion_checkpoint_checkpoint")
  @@index([guardiaId], map: "idx_ops_marcacion_checkpoint_guardia")
  @@index([timestamp], map: "idx_ops_marcacion_checkpoint_timestamp")
  @@map("marcacion_checkpoints")
  @@schema("ops")
}

model OpsAlertaRonda {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId       String    @map("tenant_id")
  ejecucionId    String    @map("ejecucion_id") @db.Uuid
  installationId String    @map("installation_id") @db.Uuid
  tipo           String
  severidad      String    @default("warning") // "info" | "warning" | "critical"
  mensaje        String
  data           Json?     @db.JsonB
  resuelta       Boolean   @default(false)
  resueltaPor    String?   @map("resuelta_por")
  resueltaAt     DateTime? @map("resuelta_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  ejecucion    OpsRondaEjecucion @relation(fields: [ejecucionId], references: [id], onDelete: Cascade)
  installation CrmInstallation   @relation(fields: [installationId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_ops_alerta_ronda_tenant")
  @@index([ejecucionId], map: "idx_ops_alerta_ronda_ejecucion")
  @@index([installationId], map: "idx_ops_alerta_ronda_installation")
  @@index([severidad], map: "idx_ops_alerta_ronda_severidad")
  @@index([resuelta], map: "idx_ops_alerta_ronda_resuelta")
  @@map("alertas_ronda")
  @@schema("ops")
}

model OpsRondaIncidente {
  id             String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId       String   @map("tenant_id")
  ejecucionId    String?  @map("ejecucion_id") @db.Uuid
  rondaTemplateId String? @map("ronda_template_id") @db.Uuid
  checkpointId   String?  @map("checkpoint_id") @db.Uuid
  guardiaId      String   @map("guardia_id") @db.Uuid
  tipo           String
  descripcion    String
  fotoUrl        String?  @map("foto_url")
  lat            Float?
  lng            Float?
  status         String   @default("abierto")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  ejecucion     OpsRondaEjecucion? @relation(fields: [ejecucionId], references: [id], onDelete: SetNull)
  rondaTemplate OpsRondaTemplate?  @relation(fields: [rondaTemplateId], references: [id], onDelete: SetNull)
  checkpoint    OpsCheckpoint?     @relation(fields: [checkpointId], references: [id], onDelete: SetNull)
  guardia       OpsGuardia         @relation(fields: [guardiaId], references: [id], onDelete: Restrict)

  @@index([tenantId], map: "idx_ops_ronda_incidente_tenant")
  @@index([ejecucionId], map: "idx_ops_ronda_incidente_ejecucion")
  @@index([guardiaId], map: "idx_ops_ronda_incidente_guardia")
  @@index([status], map: "idx_ops_ronda_incidente_status")
  @@map("ronda_incidentes")
  @@schema("ops")
}

// ============================================
// OPS — CONTROL NOCTURNO (CENTRAL DE OPERACIONES)
// ============================================

model OpsControlNocturno {
  id                   String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId             String    @map("tenant_id")
  date                 DateTime  @db.Date
  centralOperatorName  String    @map("central_operator_name")
  centralLabel         String?   @map("central_label")          // "Central II-36"
  shiftStart           String    @default("19:00") @map("shift_start")
  shiftEnd             String    @default("08:00") @map("shift_end")
  status               String    @default("borrador")            // borrador, enviado, aprobado, rechazado
  generalNotes         String?   @map("general_notes")
  submittedAt          DateTime? @map("submitted_at") @db.Timestamptz(6)
  submittedBy          String?   @map("submitted_by")
  approvedAt           DateTime? @map("approved_at") @db.Timestamptz(6)
  approvedBy           String?   @map("approved_by")
  rejectedAt           DateTime? @map("rejected_at") @db.Timestamptz(6)
  rejectedBy           String?   @map("rejected_by")
  rejectionReason      String?   @map("rejection_reason")
  createdBy            String    @map("created_by")
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  instalaciones OpsControlNocturnoInstalacion[]

  @@unique([tenantId, date, centralLabel], map: "uq_ops_control_nocturno_date_central")
  @@index([tenantId], map: "idx_ops_control_nocturno_tenant")
  @@index([tenantId, date], map: "idx_ops_control_nocturno_tenant_date")
  @@index([status], map: "idx_ops_control_nocturno_status")
  @@map("control_nocturno")
  @@schema("ops")
}

model OpsControlNocturnoInstalacion {
  id                   String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  controlNocturnoId    String    @map("control_nocturno_id") @db.Uuid
  installationId       String?   @map("installation_id") @db.Uuid
  installationName     String    @map("installation_name")
  orderIndex           Int       @default(0) @map("order_index")
  guardiasRequeridos   Int       @default(1) @map("guardias_requeridos")
  guardiasPresentes    Int       @default(0) @map("guardias_presentes")
  horaLlegadaTurnoDia  String?   @map("hora_llegada_turno_dia")
  guardiaDiaNombres    String?   @map("guardia_dia_nombres")
  statusInstalacion    String    @default("normal") @map("status_instalacion") // normal, novedad, critico, no_aplica
  notes                String?
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  controlNocturno OpsControlNocturno     @relation(fields: [controlNocturnoId], references: [id], onDelete: Cascade)
  installation    CrmInstallation?       @relation(fields: [installationId], references: [id], onDelete: SetNull)
  guardias        OpsControlNocturnoGuardia[]
  rondas          OpsControlNocturnoRonda[]

  @@index([controlNocturnoId], map: "idx_ops_cn_instalacion_control")
  @@index([installationId], map: "idx_ops_cn_instalacion_installation")
  @@map("control_nocturno_instalaciones")
  @@schema("ops")
}

model OpsControlNocturnoGuardia {
  id                      String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  controlInstalacionId    String    @map("control_instalacion_id") @db.Uuid
  guardiaId               String?   @map("guardia_id") @db.Uuid
  guardiaNombre           String    @map("guardia_nombre")
  isExtra                 Boolean   @default(false) @map("is_extra")
  horaLlegada             String?   @map("hora_llegada")
  fotoEvidenciaUrl        String?   @map("foto_evidencia_url")
  createdAt               DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  controlInstalacion OpsControlNocturnoInstalacion @relation(fields: [controlInstalacionId], references: [id], onDelete: Cascade)
  guardia            OpsGuardia?                    @relation(fields: [guardiaId], references: [id], onDelete: SetNull)

  @@index([controlInstalacionId], map: "idx_ops_cn_guardia_instalacion")
  @@index([guardiaId], map: "idx_ops_cn_guardia_guardia")
  @@map("control_nocturno_guardias")
  @@schema("ops")
}

model OpsControlNocturnoRonda {
  id                      String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  controlInstalacionId    String    @map("control_instalacion_id") @db.Uuid
  rondaNumber             Int       @map("ronda_number")          // 1-12
  horaEsperada            String    @map("hora_esperada")         // "20:00", "21:00"...
  horaMarcada             String?   @map("hora_marcada")          // hora real
  status                  String    @default("pendiente")          // pendiente, completada, omitida, no_aplica
  ejecucionRondaId        String?   @map("ejecucion_ronda_id") @db.Uuid
  notes                   String?
  createdAt               DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  controlInstalacion OpsControlNocturnoInstalacion @relation(fields: [controlInstalacionId], references: [id], onDelete: Cascade)

  @@unique([controlInstalacionId, rondaNumber], map: "uq_ops_cn_ronda_inst_number")
  @@index([controlInstalacionId], map: "idx_ops_cn_ronda_instalacion")
  @@map("control_nocturno_rondas")
  @@schema("ops")
}

model OpsTicketType {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId          String   @map("tenant_id")
  slug              String
  name              String
  description       String?
  origin            String   @default("internal")
  requiresApproval  Boolean  @default(false) @map("requires_approval")
  assignedTeam      String   @map("assigned_team")
  defaultPriority   String   @default("p3") @map("default_priority")
  slaHours          Int      @default(72) @map("sla_hours")
  icon              String?
  isActive          Boolean  @default(true) @map("is_active")
  sortOrder         Int      @default(0) @map("sort_order")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  approvalSteps     OpsTicketTypeApprovalStep[]
  tickets           OpsTicket[]

  @@unique([tenantId, slug], map: "uq_ops_ticket_types_tenant_slug")
  @@index([tenantId], map: "idx_ops_ticket_types_tenant")
  @@index([tenantId, isActive], map: "idx_ops_ticket_types_tenant_active")
  @@map("ops_ticket_types")
  @@schema("ops")
}

model OpsTicketTypeApprovalStep {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  ticketTypeId    String   @map("ticket_type_id") @db.Uuid
  stepOrder       Int      @map("step_order")
  approverType    String   @default("group") @map("approver_type")
  approverGroupId String?  @map("approver_group_id")
  approverUserId  String?  @map("approver_user_id")
  label           String
  isRequired      Boolean  @default(true) @map("is_required")

  ticketType      OpsTicketType @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)
  approverGroup   AdminGroup?   @relation(fields: [approverGroupId], references: [id], onDelete: SetNull)

  @@index([ticketTypeId], map: "idx_ops_ticket_type_approval_steps_type")
  @@map("ops_ticket_type_approval_steps")
  @@schema("ops")
}

model OpsTicket {
  id                  String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId            String    @map("tenant_id")
  code                String
  ticketTypeId        String?   @map("ticket_type_id") @db.Uuid
  status              String    @default("open")
  priority            String    @default("p3")
  title               String
  description         String?
  assignedTeam        String    @map("assigned_team")
  assignedTo          String?   @map("assigned_to")
  installationId      String?   @map("installation_id") @db.Uuid
  source              String    @default("manual")
  sourceGuardEventId  String?   @map("source_guard_event_id")
  guardiaId           String?   @map("guardia_id") @db.Uuid
  reportedBy          String    @map("reported_by")
  slaDueAt            DateTime? @map("sla_due_at") @db.Timestamptz(6)
  slaBreached         Boolean   @default(false) @map("sla_breached")
  resolvedAt          DateTime? @map("resolved_at") @db.Timestamptz(6)
  closedAt            DateTime? @map("closed_at") @db.Timestamptz(6)
  resolutionNotes     String?   @map("resolution_notes")
  tags                String[]  @default([])
  currentApprovalStep Int?      @map("current_approval_step")
  approvalStatus      String?   @map("approval_status")
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  ticketType          OpsTicketType? @relation(fields: [ticketTypeId], references: [id], onDelete: SetNull)
  guardia             OpsGuardia?    @relation(fields: [guardiaId], references: [id], onDelete: SetNull)
  approvals           OpsTicketApproval[]
  comments            OpsTicketComment[]

  @@unique([tenantId, code], map: "uq_ops_tickets_tenant_code")
  @@index([tenantId], map: "idx_ops_tickets_tenant")
  @@index([tenantId, status], map: "idx_ops_tickets_tenant_status")
  @@index([tenantId, assignedTeam], map: "idx_ops_tickets_tenant_team")
  @@index([guardiaId], map: "idx_ops_tickets_guardia")
  @@index([ticketTypeId], map: "idx_ops_tickets_type")
  @@map("ops_tickets")
  @@schema("ops")
}

model OpsTicketApproval {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  ticketId        String    @map("ticket_id") @db.Uuid
  stepOrder       Int       @map("step_order")
  stepLabel       String    @map("step_label")
  approverType    String    @map("approver_type")
  approverGroupId String?   @map("approver_group_id")
  approverUserId  String?   @map("approver_user_id")
  decision        String    @default("pending")
  decidedById     String?   @map("decided_by_id")
  comment         String?
  decidedAt       DateTime? @map("decided_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  ticket          OpsTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId], map: "idx_ops_ticket_approvals_ticket")
  @@index([ticketId, stepOrder], map: "idx_ops_ticket_approvals_ticket_step")
  @@map("ops_ticket_approvals")
  @@schema("ops")
}

model OpsTicketComment {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  ticketId   String   @map("ticket_id") @db.Uuid
  userId     String   @map("user_id")
  body       String
  isInternal Boolean  @default(false) @map("is_internal")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  ticket     OpsTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId], map: "idx_ops_ticket_comments_ticket")
  @@map("ops_ticket_comments")
  @@schema("ops")
}

// ============================================
// DOCS MODULE (Document Management System)
// ============================================

model DocCategory {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  module    String   // "crm", "payroll", "legal", "mail"
  key       String   // "contrato_servicio", "email_seguimiento", etc.
  label     String
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, module, key], map: "uq_doc_category_tenant_module_key")
  @@index([tenantId], map: "idx_doc_categories_tenant")
  @@index([tenantId, module], map: "idx_doc_categories_tenant_module")
  @@map("doc_categories")
  @@schema("docs")
}

model DocTemplate {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id")
  name        String
  description String?
  content     Json     @db.JsonB   // Tiptap JSON document
  module      String               // "crm", "payroll", "legal", "mail", "whatsapp"
  category    String               // e.g. "contrato_servicio", "proposal_sent", "general"
  tokensUsed  Json?    @db.JsonB   // ["account.name", "contact.firstName", ...]
  isActive    Boolean  @default(true) @map("is_active")
  isDefault   Boolean  @default(false) @map("is_default")
  /// Si module=whatsapp: slug de uso del sistema (proposal_sent, followup_first, ...). Null = plantilla personalizada para elegir desde CRM.
  usageSlug   String?  @map("usage_slug")
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  versions  DocTemplateVersion[]
  documents Document[]

  @@unique([tenantId, module, name], map: "uq_doc_template_tenant_module_name")
  @@unique([tenantId, usageSlug], map: "uq_doc_template_tenant_usage_slug")
  @@index([tenantId], map: "idx_doc_templates_tenant")
  @@index([module], map: "idx_doc_templates_module")
  @@index([isActive], map: "idx_doc_templates_active")
  @@index([tenantId, module], map: "idx_doc_templates_tenant_module")
  @@map("doc_templates")
  @@schema("docs")
}

model DocTemplateVersion {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  templateId String   @map("template_id") @db.Uuid
  version    Int
  content    Json     @db.JsonB
  changeNote String?  @map("change_note")
  createdBy  String   @map("created_by")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  template DocTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, version], map: "uq_doc_template_version")
  @@index([templateId], map: "idx_doc_template_versions_template")
  @@map("doc_template_versions")
  @@schema("docs")
}

model Document {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String    @map("tenant_id")
  uniqueId        String    @unique @default(cuid())
  templateId      String?   @map("template_id") @db.Uuid
  title           String
  content         Json      @db.JsonB      // Tiptap JSON con tokens resueltos
  tokenValues     Json?     @map("token_values") @db.JsonB
  module          String                    // "crm", "payroll", "legal"
  category        String                    // "contrato_servicio", "contrato_laboral"
  status          String    @default("draft") // draft, review, approved, active, expiring, expired, renewed
  effectiveDate   DateTime? @map("effective_date") @db.Date
  expirationDate  DateTime? @map("expiration_date") @db.Date
  renewalDate     DateTime? @map("renewal_date") @db.Date
  alertDaysBefore Int       @default(30) @map("alert_days_before")
  signatureStatus String?   @map("signature_status")
  signedAt        DateTime? @map("signed_at") @db.Timestamptz(6)
  signedBy        String?   @map("signed_by")
  signatureData   Json?     @map("signature_data") @db.JsonB
  pdfUrl          String?   @map("pdf_url")
  pdfGeneratedAt  DateTime? @map("pdf_generated_at") @db.Timestamptz(6)
  signedViewToken String?   @unique @map("signed_view_token")
  createdBy       String    @map("created_by")
  approvedBy      String?   @map("approved_by")
  approvedAt      DateTime? @map("approved_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  template     DocTemplate?    @relation(fields: [templateId], references: [id], onDelete: SetNull)
  associations DocAssociation[]
  history      DocHistory[]
  signatureRequests DocSignatureRequest[]

  @@index([tenantId], map: "idx_documents_tenant")
  @@index([tenantId, module], map: "idx_documents_tenant_module")
  @@index([tenantId, status], map: "idx_documents_tenant_status")
  @@index([expirationDate], map: "idx_documents_expiration")
  @@index([uniqueId], map: "idx_documents_unique_id")
  @@map("documents")
  @@schema("docs")
}

model DocSignatureRequest {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String    @map("tenant_id")
  documentId  String    @map("document_id") @db.Uuid
  status      String    @default("draft") // draft, pending, in_progress, completed, cancelled, expired
  message     String?
  expiresAt   DateTime? @map("expires_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  createdBy   String    @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  document   Document              @relation(fields: [documentId], references: [id], onDelete: Cascade)
  recipients DocSignatureRecipient[]

  @@index([tenantId], map: "idx_doc_signature_requests_tenant")
  @@index([documentId], map: "idx_doc_signature_requests_document")
  @@index([status], map: "idx_doc_signature_requests_status")
  @@index([expiresAt], map: "idx_doc_signature_requests_expires_at")
  @@index([createdAt(sort: Desc)], map: "idx_doc_signature_requests_created_desc")
  @@map("doc_signature_requests")
  @@schema("docs")
}

model DocSignatureRecipient {
  id                  String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  requestId           String    @map("request_id") @db.Uuid
  token               String    @unique
  name                String
  email               String
  rut                 String?
  role                String    @default("signer") // signer, cc
  signingOrder        Int       @default(1) @map("signing_order")
  status              String    @default("pending") // pending, sent, viewed, signed, declined, expired
  signedAt            DateTime? @map("signed_at") @db.Timestamptz(6)
  signatureMethod     String?   @map("signature_method") // typed, drawn, uploaded
  signatureImageUrl   String?   @map("signature_image_url")
  signatureTypedName  String?   @map("signature_typed_name")
  signatureFontFamily String?   @map("signature_font_family")
  ipAddress           String?   @map("ip_address")
  userAgent           String?   @map("user_agent")
  viewedAt            DateTime? @map("viewed_at") @db.Timestamptz(6)
  sentAt              DateTime? @map("sent_at") @db.Timestamptz(6)
  declineReason       String?   @map("decline_reason")
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  request DocSignatureRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId], map: "idx_doc_signature_recipients_request")
  @@index([email], map: "idx_doc_signature_recipients_email")
  @@index([status], map: "idx_doc_signature_recipients_status")
  @@index([signingOrder], map: "idx_doc_signature_recipients_order")
  @@index([token], map: "idx_doc_signature_recipients_token")
  @@map("doc_signature_recipients")
  @@schema("docs")
}

model DocAssociation {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  documentId String   @map("document_id") @db.Uuid
  entityType String   @map("entity_type") // "crm_account", "crm_deal", "crm_installation", "crm_contact"
  entityId   String   @map("entity_id") @db.Uuid
  role       String   @default("primary")  // "primary", "related", "copy"
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, entityType, entityId], map: "uq_doc_association")
  @@index([entityType, entityId], map: "idx_doc_associations_entity")
  @@index([documentId], map: "idx_doc_associations_document")
  @@map("doc_associations")
  @@schema("docs")
}

model DocHistory {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  documentId String   @map("document_id") @db.Uuid
  action     String   // "created", "edited", "status_changed", "signed", "pdf_generated"
  details    Json?    @db.JsonB
  createdBy  String   @map("created_by")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId], map: "idx_doc_history_document")
  @@index([createdAt(sort: Desc)], map: "idx_doc_history_created_desc")
  @@map("doc_history")
  @@schema("docs")
}

// ═══════════════════════════════════════════════════════════════════════════════
//  SCHEMA: finance — Rendiciones de Gastos
// ═══════════════════════════════════════════════════════════════════════════════

model FinanceRendicionConfig {
  id                    String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId              String   @unique @map("tenant_id")
  tenant                Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Parámetros de kilometraje
  kmPerLiter            Decimal  @default(10) @map("km_per_liter") @db.Decimal(6, 2)
  fuelPricePerLiter     Int      @default(1500) @map("fuel_price_per_liter")
  vehicleFeePct         Decimal  @default(10) @map("vehicle_fee_pct") @db.Decimal(5, 2)

  // Reglas de obligatoriedad
  requireImage          Boolean  @default(true) @map("require_image")
  requireObservations   Boolean  @default(false) @map("require_observations")
  requireTollImage      Boolean  @default(false) @map("require_toll_image")

  // Aprobadores por defecto (Admin users)
  defaultApprover1Id    String?  @map("default_approver_1_id")
  defaultApprover2Id    String?  @map("default_approver_2_id")

  // Límites globales CLP
  maxDailyAmount        Int?     @map("max_daily_amount")
  maxMonthlyAmount      Int?     @map("max_monthly_amount")

  // Alertas
  pendingAlertDays      Int      @default(5) @map("pending_alert_days")
  approvalAlertDays     Int      @default(3) @map("approval_alert_days")

  // Cuenta origen Santander
  santanderAccountNumber String? @map("santander_account_number")

  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("finance_rendicion_config")
  @@schema("finance")
}

model FinanceRendicionItem {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id")
  name        String
  code        String?
  category    String?
  active      Boolean  @default(true)
  maxPerDay   Int?     @map("max_per_day")
  maxPerMonth Int?     @map("max_per_month")
  accountCode String?  @map("account_code")

  rendiciones FinanceRendicion[]

  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, name], map: "uq_finance_item_tenant_name")
  @@index([tenantId], map: "idx_finance_items_tenant")
  @@map("finance_rendicion_items")
  @@schema("finance")
}

model FinanceCostCenter {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id")
  name            String
  code            String?
  active          Boolean  @default(true)
  installationId  String?  @map("installation_id") @db.Uuid
  accountId       String?  @map("account_id") @db.Uuid

  rendiciones     FinanceRendicion[]

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, code], map: "uq_finance_cost_center_code")
  @@index([tenantId], map: "idx_finance_cost_centers_tenant")
  @@map("finance_cost_centers")
  @@schema("finance")
}

model FinanceRendicion {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id")
  code            String   @unique
  submitterId     String   @map("submitter_id")
  type            String   @default("PURCHASE") // PURCHASE | MILEAGE
  status          String   @default("DRAFT") // DRAFT | SUBMITTED | IN_APPROVAL | APPROVED | REJECTED | PAID
  amount          Int      @default(0)
  date            DateTime @db.Date
  description     String?
  documentType    String?  @map("document_type") // BOLETA | FACTURA
  itemId          String?  @map("item_id") @db.Uuid
  item            FinanceRendicionItem? @relation(fields: [itemId], references: [id], onDelete: SetNull)
  tripId          String?  @unique @map("trip_id") @db.Uuid
  trip            FinanceTrip? @relation(fields: [tripId], references: [id], onDelete: SetNull)
  costCenterId    String?  @map("cost_center_id") @db.Uuid
  costCenter      FinanceCostCenter? @relation(fields: [costCenterId], references: [id], onDelete: SetNull)
  paymentId       String?  @map("payment_id") @db.Uuid
  payment         FinancePayment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  paidAt          DateTime? @map("paid_at") @db.Timestamptz(6)
  paymentMethod   String?  @map("payment_method")
  rejectedAt      DateTime? @map("rejected_at") @db.Timestamptz(6)
  rejectionReason String?  @map("rejection_reason")
  rejectedById    String?  @map("rejected_by_id")
  submittedAt     DateTime? @map("submitted_at") @db.Timestamptz(6)

  approvals       FinanceApproval[]
  attachments     FinanceAttachment[]
  history         FinanceRendicionHistory[]

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([tenantId, submitterId], map: "idx_finance_rendiciones_tenant_submitter")
  @@index([tenantId, status], map: "idx_finance_rendiciones_tenant_status")
  @@index([tenantId, date], map: "idx_finance_rendiciones_tenant_date")
  @@index([code], map: "idx_finance_rendiciones_code")
  @@map("finance_rendiciones")
  @@schema("finance")
}

model FinanceRendicionHistory {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  rendicionId   String   @map("rendicion_id") @db.Uuid
  rendicion     FinanceRendicion @relation(fields: [rendicionId], references: [id], onDelete: Cascade)
  action        String   // CREATED | SUBMITTED | APPROVED | REJECTED | PAID | EDITED | RESUBMITTED
  fromStatus    String?  @map("from_status")
  toStatus      String?  @map("to_status")
  userId        String   @map("user_id")
  userName      String?  @map("user_name")
  comment       String?
  metadata      Json?    @db.JsonB
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([rendicionId], map: "idx_finance_history_rendicion")
  @@index([createdAt(sort: Desc)], map: "idx_finance_history_created_desc")
  @@map("finance_rendicion_history")
  @@schema("finance")
}

model FinanceTrip {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id")
  submitterId     String   @map("submitter_id")
  startLat        Decimal  @map("start_lat") @db.Decimal(10, 7)
  startLng        Decimal  @map("start_lng") @db.Decimal(10, 7)
  startAddress    String?  @map("start_address")
  startedAt       DateTime @map("started_at") @db.Timestamptz(6)
  endLat          Decimal? @map("end_lat") @db.Decimal(10, 7)
  endLng          Decimal? @map("end_lng") @db.Decimal(10, 7)
  endAddress      String?  @map("end_address")
  endedAt         DateTime? @map("ended_at") @db.Timestamptz(6)
  distanceKm      Decimal? @map("distance_km") @db.Decimal(8, 2)
  litersConsumed  Decimal? @map("liters_consumed") @db.Decimal(8, 2)
  fuelCost        Int?     @map("fuel_cost")
  vehicleFee      Int?     @map("vehicle_fee")
  subtotal        Int?
  tollAmount      Int      @default(0) @map("toll_amount")
  totalAmount     Int?     @map("total_amount")
  snapshotKmPerLiter    Decimal? @map("snapshot_km_per_liter") @db.Decimal(6, 2)
  snapshotFuelPrice     Int?     @map("snapshot_fuel_price")
  snapshotFeePct        Decimal? @map("snapshot_fee_pct") @db.Decimal(5, 2)
  status          String   @default("IN_PROGRESS") // IN_PROGRESS | COMPLETED | CANCELLED

  rendicion       FinanceRendicion?
  attachments     FinanceAttachment[]

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([tenantId, submitterId], map: "idx_finance_trips_tenant_submitter")
  @@index([status], map: "idx_finance_trips_status")
  @@map("finance_trips")
  @@schema("finance")
}

model FinanceApproval {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  rendicionId     String   @map("rendicion_id") @db.Uuid
  rendicion       FinanceRendicion @relation(fields: [rendicionId], references: [id], onDelete: Cascade)
  approverId      String   @map("approver_id")
  approvalOrder   Int      @default(1) @map("approval_order")
  decision        String?  // APPROVED | REJECTED
  comment         String?
  decidedAt       DateTime? @map("decided_at") @db.Timestamptz(6)

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([rendicionId, approverId], map: "uq_finance_approval_rendicion_approver")
  @@index([rendicionId], map: "idx_finance_approvals_rendicion")
  @@index([approverId], map: "idx_finance_approvals_approver")
  @@map("finance_approvals")
  @@schema("finance")
}

model FinanceAttachment {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id")
  rendicionId     String?  @map("rendicion_id") @db.Uuid
  rendicion       FinanceRendicion? @relation(fields: [rendicionId], references: [id], onDelete: Cascade)
  tripId          String?  @map("trip_id") @db.Uuid
  trip            FinanceTrip? @relation(fields: [tripId], references: [id], onDelete: Cascade)
  fileName        String   @map("file_name")
  mimeType        String   @map("mime_type")
  size            Int
  storageKey      String   @map("storage_key")
  publicUrl       String   @map("public_url")
  attachmentType  String   @default("OTHER") @map("attachment_type") // RECEIPT | INVOICE | TOLL | OTHER
  uploadedById    String   @map("uploaded_by_id")

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([rendicionId], map: "idx_finance_attachments_rendicion")
  @@index([tripId], map: "idx_finance_attachments_trip")
  @@map("finance_attachments")
  @@schema("finance")
}

model FinancePayment {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id")
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  code            String   @unique
  type            String   @default("MANUAL") // BATCH_SANTANDER | MANUAL
  bankFileName    String?  @map("bank_file_name")
  bankFileUrl     String?  @map("bank_file_url")
  totalAmount     Int      @map("total_amount")
  rendicionCount  Int      @map("rendicion_count")
  paidById        String   @map("paid_by_id")
  paidAt          DateTime @default(now()) @map("paid_at") @db.Timestamptz(6)
  notes           String?

  rendiciones     FinanceRendicion[]

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([tenantId], map: "idx_finance_payments_tenant")
  @@index([code], map: "idx_finance_payments_code")
  @@map("finance_payments")
  @@schema("finance")
}

// ── ERP: Account Types ──
enum FinanceAccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  COST
  EXPENSE

  @@schema("finance")
}

enum FinanceAccountNature {
  DEBIT
  CREDIT

  @@schema("finance")
}

enum FinancePeriodStatus {
  OPEN
  CLOSED
  LOCKED

  @@schema("finance")
}

enum FinanceJournalStatus {
  DRAFT
  POSTED
  REVERSED

  @@schema("finance")
}

enum FinanceJournalSourceType {
  MANUAL
  INVOICE_ISSUED
  INVOICE_RECEIVED
  PAYMENT
  RECONCILIATION
  FACTORING
  EXPENSE_REPORT
  OPENING
  CLOSING

  @@schema("finance")
}

enum FinanceThirdPartyType {
  CUSTOMER
  SUPPLIER

  @@schema("finance")
}

// ── ERP: Plan de Cuentas ──
model FinanceAccountPlan {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id")
  code            String
  name            String
  type            FinanceAccountType
  nature          FinanceAccountNature
  parentId        String?  @map("parent_id") @db.Uuid
  parent          FinanceAccountPlan?  @relation("AccountHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children        FinanceAccountPlan[] @relation("AccountHierarchy")
  level           Int      @default(1)
  isSystem        Boolean  @default(false) @map("is_system")
  isActive        Boolean  @default(true) @map("is_active")
  acceptsEntries  Boolean  @default(true) @map("accepts_entries")
  description     String?
  taxCode         String?  @map("tax_code")

  journalLines    FinanceJournalLine[]
  bankAccounts    FinanceBankAccount[]
  dteLines        FinanceDteLine[]
  supplierPayable FinanceSupplier[]   @relation("SupplierPayableAccount")
  supplierExpense FinanceSupplier[]   @relation("SupplierExpenseAccount")
  cashRegisters   FinanceCashRegister[]

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, code], map: "uq_finance_account_plan_code")
  @@index([tenantId], map: "idx_finance_account_plan_tenant")
  @@index([tenantId, type], map: "idx_finance_account_plan_type")
  @@map("finance_account_plan")
  @@schema("finance")
}

// ── ERP: Periodos Contables ──
model FinanceAccountingPeriod {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id")
  year            Int
  month           Int
  startDate       DateTime @map("start_date") @db.Date
  endDate         DateTime @map("end_date") @db.Date
  status          FinancePeriodStatus @default(OPEN)
  closedBy        String?  @map("closed_by")
  closedAt        DateTime? @map("closed_at") @db.Timestamptz(6)

  journalEntries  FinanceJournalEntry[]

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, year, month], map: "uq_finance_period_tenant_year_month")
  @@index([tenantId], map: "idx_finance_period_tenant")
  @@map("finance_accounting_periods")
  @@schema("finance")
}

// ── ERP: Asientos Contables ──
model FinanceJournalEntry {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id")
  number          Int
  date            DateTime @db.Date
  periodId        String   @map("period_id") @db.Uuid
  period          FinanceAccountingPeriod @relation(fields: [periodId], references: [id])
  description     String
  reference       String?
  sourceType      FinanceJournalSourceType @default(MANUAL) @map("source_type")
  sourceId        String?  @map("source_id")
  status          FinanceJournalStatus @default(DRAFT)
  reversedById    String?  @unique @map("reversed_by_id") @db.Uuid
  reversedBy      FinanceJournalEntry? @relation("JournalReversal", fields: [reversedById], references: [id])
  reversalOf      FinanceJournalEntry? @relation("JournalReversal")
  costCenterId    String?  @map("cost_center_id") @db.Uuid
  totalDebit      Decimal  @default(0) @map("total_debit") @db.Decimal(14, 2)
  totalCredit     Decimal  @default(0) @map("total_credit") @db.Decimal(14, 2)
  createdBy       String   @map("created_by")
  postedBy        String?  @map("posted_by")
  postedAt        DateTime? @map("posted_at") @db.Timestamptz(6)

  lines           FinanceJournalLine[]
  dtes            FinanceDte[]
  payments        FinancePaymentRecord[]
  reconcMatches   FinanceReconciliationMatch[]
  factoringOps    FinanceFactoringOperation[] @relation("FactoringCession")
  factoringColls  FinanceFactoringOperation[] @relation("FactoringCollection")

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, number], map: "uq_finance_journal_tenant_number")
  @@index([tenantId, date], map: "idx_finance_journal_tenant_date")
  @@index([tenantId, sourceType, sourceId], map: "idx_finance_journal_source")
  @@map("finance_journal_entries")
  @@schema("finance")
}

model FinanceJournalLine {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  entryId         String   @map("entry_id") @db.Uuid
  entry           FinanceJournalEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  accountId       String   @map("account_id") @db.Uuid
  account         FinanceAccountPlan @relation(fields: [accountId], references: [id])
  description     String?
  debit           Decimal  @default(0) @db.Decimal(14, 2)
  credit          Decimal  @default(0) @db.Decimal(14, 2)
  costCenterId    String?  @map("cost_center_id") @db.Uuid
  thirdPartyId    String?  @map("third_party_id")
  thirdPartyType  FinanceThirdPartyType? @map("third_party_type")

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([entryId], map: "idx_finance_journal_line_entry")
  @@index([accountId], map: "idx_finance_journal_line_account")
  @@map("finance_journal_lines")
  @@schema("finance")
}

// ── ERP: Auditoria ──
model FinanceAuditLog {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id")
  userId          String   @map("user_id")
  userName        String   @map("user_name")
  action          String
  entityType      String   @map("entity_type")
  entityId        String   @map("entity_id")
  previousData    Json?    @map("previous_data")
  newData         Json?    @map("new_data")
  ipAddress       String?  @map("ip_address")

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([tenantId, entityType, entityId], map: "idx_finance_audit_entity")
  @@index([tenantId, createdAt], map: "idx_finance_audit_date")
  @@map("finance_audit_log")
  @@schema("finance")
}

enum FinanceDteDirection {
  ISSUED
  RECEIVED
  @@schema("finance")
}

enum FinanceCurrency {
  CLP
  USD
  UF
  @@schema("finance")
}

enum FinanceSiiStatus {
  PENDING
  SENT
  ACCEPTED
  REJECTED
  WITH_OBJECTIONS
  ANNULLED
  @@schema("finance")
}

enum FinanceReceptionStatus {
  PENDING_REVIEW
  ACCEPTED
  CLAIMED
  PARTIAL_CLAIM
  EXPIRED
  @@schema("finance")
}

enum FinancePaymentStatus {
  UNPAID
  PARTIAL
  PAID
  OVERDUE
  WRITTEN_OFF
  @@schema("finance")
}

enum FinanceBankAccountType {
  CHECKING
  SAVINGS
  VISTA
  @@schema("finance")
}

enum FinanceBankTxSource {
  API
  MANUAL
  CSV_IMPORT
  @@schema("finance")
}

enum FinanceReconciliationStatus {
  UNMATCHED
  MATCHED
  RECONCILED
  EXCLUDED
  @@schema("finance")
}

enum FinanceReconcPeriodStatus {
  IN_PROGRESS
  COMPLETED
  APPROVED
  @@schema("finance")
}

enum FinanceMatchType {
  AUTO
  MANUAL
  @@schema("finance")
}

enum FinancePaymentRecordType {
  COLLECTION
  DISBURSEMENT
  @@schema("finance")
}

enum FinancePaymentMethod {
  TRANSFER
  CHECK
  CASH
  CREDIT_CARD
  FACTORING
  COMPENSATION
  OTHER
  @@schema("finance")
}

enum FinancePaymentRecordStatus {
  PENDING
  CONFIRMED
  CANCELLED
  @@schema("finance")
}

enum FinanceFactoringStatus {
  SIMULATED
  SUBMITTED
  APPROVED
  FUNDED
  COLLECTED
  CANCELLED
  @@schema("finance")
}

// ── ERP: Proveedores ──
model FinanceSupplier {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId          String   @map("tenant_id")
  rut               String
  name              String
  tradeName         String?  @map("trade_name")
  address           String?
  commune           String?
  city              String?
  email             String?
  phone             String?
  contactName       String?  @map("contact_name")
  paymentTermDays   Int      @default(30) @map("payment_term_days")
  accountPayableId  String?  @map("account_payable_id") @db.Uuid
  accountPayable    FinanceAccountPlan? @relation("SupplierPayableAccount", fields: [accountPayableId], references: [id])
  accountExpenseId  String?  @map("account_expense_id") @db.Uuid
  accountExpense    FinanceAccountPlan? @relation("SupplierExpenseAccount", fields: [accountExpenseId], references: [id])
  isActive          Boolean  @default(true) @map("is_active")

  dtes              FinanceDte[]
  payments          FinancePaymentRecord[]

  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, rut], map: "uq_finance_supplier_rut")
  @@index([tenantId], map: "idx_finance_supplier_tenant")
  @@map("finance_suppliers")
  @@schema("finance")
}

// ── ERP: DTE (Documentos Tributarios Electronicos) ──
model FinanceDte {
  id                  String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId            String   @map("tenant_id")
  direction           FinanceDteDirection
  dteType             Int      @map("dte_type")
  folio               Int
  code                String
  date                DateTime @db.Date
  dueDate             DateTime? @map("due_date") @db.Date

  issuerRut           String   @map("issuer_rut")
  issuerName          String   @map("issuer_name")
  receiverRut         String   @map("receiver_rut")
  receiverName        String   @map("receiver_name")
  receiverEmail       String?  @map("receiver_email")

  referenceDteId      String?  @map("reference_dte_id") @db.Uuid
  referenceDte        FinanceDte? @relation("DteReference", fields: [referenceDteId], references: [id])
  referencedBy        FinanceDte[] @relation("DteReference")
  referenceType       Int?     @map("reference_type")
  referenceFolio      Int?     @map("reference_folio")
  referenceReason     String?  @map("reference_reason")

  currency            FinanceCurrency @default(CLP)
  exchangeRate        Decimal? @map("exchange_rate") @db.Decimal(10, 4)
  netAmount           Decimal  @map("net_amount") @db.Decimal(14, 2)
  exemptAmount        Decimal  @default(0) @map("exempt_amount") @db.Decimal(14, 2)
  taxRate             Decimal  @default(19.00) @map("tax_rate") @db.Decimal(5, 2)
  taxAmount           Decimal  @map("tax_amount") @db.Decimal(14, 2)
  totalAmount         Decimal  @map("total_amount") @db.Decimal(14, 2)

  accountId           String?  @map("account_id")
  contactId           String?  @map("contact_id")
  supplierId          String?  @map("supplier_id") @db.Uuid
  supplier            FinanceSupplier? @relation(fields: [supplierId], references: [id])

  siiStatus           FinanceSiiStatus @default(PENDING) @map("sii_status")
  siiTrackId          String?  @map("sii_track_id")
  siiResponse         Json?    @map("sii_response")
  siiAcceptedAt       DateTime? @map("sii_accepted_at") @db.Timestamptz(6)

  receptionStatus     FinanceReceptionStatus? @map("reception_status")
  receptionDeadline   DateTime? @map("reception_deadline") @db.Date
  receptionDecidedAt  DateTime? @map("reception_decided_at") @db.Timestamptz(6)
  receptionDecidedBy  String?  @map("reception_decided_by")
  claimType           Int?     @map("claim_type")

  pdfUrl              String?  @map("pdf_url")
  xmlUrl              String?  @map("xml_url")
  cedible             Boolean  @default(false)

  journalEntryId      String?  @map("journal_entry_id") @db.Uuid
  journalEntry        FinanceJournalEntry? @relation(fields: [journalEntryId], references: [id])
  paymentStatus       FinancePaymentStatus @default(UNPAID) @map("payment_status")
  amountPaid          Decimal  @default(0) @map("amount_paid") @db.Decimal(14, 2)
  amountPending       Decimal  @default(0) @map("amount_pending") @db.Decimal(14, 2)

  notes               String?
  createdBy           String   @map("created_by")

  lines               FinanceDteLine[]
  paymentAllocations  FinancePaymentAllocation[]
  factoringOps        FinanceFactoringOperation[]

  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, direction, dteType, folio], map: "uq_finance_dte_folio")
  @@index([tenantId, direction, paymentStatus], map: "idx_finance_dte_payment_status")
  @@index([tenantId, accountId], map: "idx_finance_dte_account")
  @@index([tenantId, supplierId], map: "idx_finance_dte_supplier")
  @@index([tenantId, date], map: "idx_finance_dte_date")
  @@map("finance_dtes")
  @@schema("finance")
}

model FinanceDteLine {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  dteId           String   @map("dte_id") @db.Uuid
  dte             FinanceDte @relation(fields: [dteId], references: [id], onDelete: Cascade)
  lineNumber      Int      @map("line_number")
  itemCode        String?  @map("item_code")
  itemName        String   @map("item_name")
  description     String?
  quantity        Decimal  @db.Decimal(12, 4)
  unit            String?
  unitPrice       Decimal  @map("unit_price") @db.Decimal(14, 4)
  discountPct     Decimal  @default(0) @map("discount_pct") @db.Decimal(5, 2)
  netAmount       Decimal  @map("net_amount") @db.Decimal(14, 2)
  isExempt        Boolean  @default(false) @map("is_exempt")
  accountId       String?  @map("account_id") @db.Uuid
  account         FinanceAccountPlan? @relation(fields: [accountId], references: [id])
  costCenterId    String?  @map("cost_center_id") @db.Uuid

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([dteId], map: "idx_finance_dte_line_dte")
  @@map("finance_dte_lines")
  @@schema("finance")
}

// ── ERP: Tesoreria ──
model FinanceBankAccount {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId          String   @map("tenant_id")
  bankCode          String   @map("bank_code")
  bankName          String   @map("bank_name")
  accountType       FinanceBankAccountType @map("account_type")
  accountNumber     String   @map("account_number")
  currency          FinanceCurrency @default(CLP)
  holderName        String   @map("holder_name")
  holderRut         String   @map("holder_rut")
  accountPlanId     String?  @map("account_plan_id") @db.Uuid
  accountPlan       FinanceAccountPlan? @relation(fields: [accountPlanId], references: [id])
  isActive          Boolean  @default(true) @map("is_active")
  isDefault         Boolean  @default(false) @map("is_default")
  apiProvider       String?  @map("api_provider")
  apiLinkId         String?  @map("api_link_id")
  apiAccountId      String?  @map("api_account_id")
  apiLastSync       DateTime? @map("api_last_sync") @db.Timestamptz(6)
  currentBalance    Decimal? @map("current_balance") @db.Decimal(14, 2)
  balanceUpdatedAt  DateTime? @map("balance_updated_at") @db.Timestamptz(6)

  transactions      FinanceBankTransaction[]
  reconciliations   FinanceReconciliation[]
  paymentsFrom      FinancePaymentRecord[]

  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, bankCode, accountNumber], map: "uq_finance_bank_account")
  @@index([tenantId], map: "idx_finance_bank_account_tenant")
  @@map("finance_bank_accounts")
  @@schema("finance")
}

model FinanceBankTransaction {
  id                    String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId              String   @map("tenant_id")
  bankAccountId         String   @map("bank_account_id") @db.Uuid
  bankAccount           FinanceBankAccount @relation(fields: [bankAccountId], references: [id])
  transactionDate       DateTime @map("transaction_date") @db.Date
  valueDate             DateTime? @map("value_date") @db.Date
  description           String
  reference             String?
  amount                Decimal  @db.Decimal(14, 2)
  balance               Decimal? @db.Decimal(14, 2)
  category              String?
  source                FinanceBankTxSource @default(MANUAL)
  apiTransactionId      String?  @map("api_transaction_id")
  reconciliationStatus  FinanceReconciliationStatus @default(UNMATCHED) @map("reconciliation_status")
  reconciliationId      String?  @map("reconciliation_id") @db.Uuid

  reconcMatch           FinanceReconciliationMatch?

  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, bankAccountId, apiTransactionId], map: "uq_finance_bank_tx_api")
  @@index([tenantId, bankAccountId, transactionDate], map: "idx_finance_bank_tx_date")
  @@index([reconciliationStatus], map: "idx_finance_bank_tx_reconc")
  @@map("finance_bank_transactions")
  @@schema("finance")
}

model FinanceCashRegister {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id")
  name            String
  accountPlanId   String?  @map("account_plan_id") @db.Uuid
  accountPlan     FinanceAccountPlan? @relation(fields: [accountPlanId], references: [id])
  currentBalance  Decimal  @default(0) @map("current_balance") @db.Decimal(14, 2)
  isActive        Boolean  @default(true) @map("is_active")

  payments        FinancePaymentRecord[]

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, name], map: "uq_finance_cash_register_name")
  @@index([tenantId], map: "idx_finance_cash_register_tenant")
  @@map("finance_cash_registers")
  @@schema("finance")
}

// ── ERP: Pagos y Conciliacion ──
model FinancePaymentRecord {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId          String   @map("tenant_id")
  code              String
  type              FinancePaymentRecordType
  date              DateTime @db.Date
  amount            Decimal  @db.Decimal(14, 2)
  currency          FinanceCurrency @default(CLP)
  exchangeRate      Decimal? @map("exchange_rate") @db.Decimal(10, 4)
  paymentMethod     FinancePaymentMethod @map("payment_method")
  bankAccountId     String?  @map("bank_account_id") @db.Uuid
  bankAccount       FinanceBankAccount? @relation(fields: [bankAccountId], references: [id])
  cashRegisterId    String?  @map("cash_register_id") @db.Uuid
  cashRegister      FinanceCashRegister? @relation(fields: [cashRegisterId], references: [id])
  checkNumber       String?  @map("check_number")
  transferReference String?  @map("transfer_reference")
  accountId         String?  @map("account_id")
  supplierId        String?  @map("supplier_id") @db.Uuid
  supplier          FinanceSupplier? @relation(fields: [supplierId], references: [id])
  journalEntryId    String?  @map("journal_entry_id") @db.Uuid
  journalEntry      FinanceJournalEntry? @relation(fields: [journalEntryId], references: [id])
  status            FinancePaymentRecordStatus @default(PENDING)
  notes             String?
  createdBy         String   @map("created_by")

  allocations       FinancePaymentAllocation[]
  reconcMatch       FinanceReconciliationMatch?

  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, code], map: "uq_finance_payment_record_code")
  @@index([tenantId, type, date], map: "idx_finance_payment_record_type_date")
  @@map("finance_payment_records")
  @@schema("finance")
}

model FinancePaymentAllocation {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  paymentId       String   @map("payment_id") @db.Uuid
  payment         FinancePaymentRecord @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  dteId           String   @map("dte_id") @db.Uuid
  dte             FinanceDte @relation(fields: [dteId], references: [id])
  amount          Decimal  @db.Decimal(14, 2)

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([paymentId], map: "idx_finance_pay_alloc_payment")
  @@index([dteId], map: "idx_finance_pay_alloc_dte")
  @@map("finance_payment_allocations")
  @@schema("finance")
}

model FinanceReconciliation {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id")
  bankAccountId   String   @map("bank_account_id") @db.Uuid
  bankAccount     FinanceBankAccount @relation(fields: [bankAccountId], references: [id])
  periodYear      Int      @map("period_year")
  periodMonth     Int      @map("period_month")
  status          FinanceReconcPeriodStatus @default(IN_PROGRESS)
  bankBalance     Decimal  @default(0) @map("bank_balance") @db.Decimal(14, 2)
  bookBalance     Decimal  @default(0) @map("book_balance") @db.Decimal(14, 2)
  difference      Decimal  @default(0) @db.Decimal(14, 2)
  completedBy     String?  @map("completed_by")
  completedAt     DateTime? @map("completed_at") @db.Timestamptz(6)
  approvedBy      String?  @map("approved_by")
  approvedAt      DateTime? @map("approved_at") @db.Timestamptz(6)

  matches         FinanceReconciliationMatch[]

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, bankAccountId, periodYear, periodMonth], map: "uq_finance_reconc_period")
  @@map("finance_reconciliations")
  @@schema("finance")
}

model FinanceReconciliationMatch {
  id                  String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  reconciliationId    String   @map("reconciliation_id") @db.Uuid
  reconciliation      FinanceReconciliation @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)
  bankTransactionId   String   @unique @map("bank_transaction_id") @db.Uuid
  bankTransaction     FinanceBankTransaction @relation(fields: [bankTransactionId], references: [id])
  paymentRecordId     String?  @unique @map("payment_record_id") @db.Uuid
  paymentRecord       FinancePaymentRecord? @relation(fields: [paymentRecordId], references: [id])
  journalEntryId      String?  @map("journal_entry_id") @db.Uuid
  journalEntry        FinanceJournalEntry? @relation(fields: [journalEntryId], references: [id])
  matchType           FinanceMatchType @map("match_type")
  matchConfidence     Decimal? @map("match_confidence") @db.Decimal(5, 2)
  createdBy           String?  @map("created_by")

  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([reconciliationId], map: "idx_finance_reconc_match_reconc")
  @@map("finance_reconciliation_matches")
  @@schema("finance")
}

// ── ERP: Factoring ──
model FinanceFactoringOperation {
  id                  String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId            String   @map("tenant_id")
  code                String
  dteId               String   @map("dte_id") @db.Uuid
  dte                 FinanceDte @relation(fields: [dteId], references: [id])
  factoringCompany    String   @map("factoring_company")
  invoiceAmount       Decimal  @map("invoice_amount") @db.Decimal(14, 2)
  advanceRate         Decimal  @map("advance_rate") @db.Decimal(5, 2)
  advanceAmount       Decimal  @map("advance_amount") @db.Decimal(14, 2)
  interestRate        Decimal  @map("interest_rate") @db.Decimal(6, 4)
  interestAmount      Decimal  @map("interest_amount") @db.Decimal(14, 2)
  commissionAmount    Decimal  @map("commission_amount") @db.Decimal(14, 2)
  netAdvance          Decimal  @map("net_advance") @db.Decimal(14, 2)
  retentionAmount     Decimal  @map("retention_amount") @db.Decimal(14, 2)
  status              FinanceFactoringStatus @default(SIMULATED)
  submittedAt         DateTime? @map("submitted_at") @db.Timestamptz(6)
  fundedAt            DateTime? @map("funded_at") @db.Timestamptz(6)
  collectedAt         DateTime? @map("collected_at") @db.Timestamptz(6)
  cessionRegistered   Boolean  @default(false) @map("cession_registered")
  cessionDate         DateTime? @map("cession_date") @db.Date
  cessionSiiStatus    String?  @map("cession_sii_status")
  journalEntryId      String?  @map("journal_entry_id") @db.Uuid
  journalEntry        FinanceJournalEntry? @relation("FactoringCession", fields: [journalEntryId], references: [id])
  collectionEntryId   String?  @map("collection_entry_id") @db.Uuid
  collectionEntry     FinanceJournalEntry? @relation("FactoringCollection", fields: [collectionEntryId], references: [id])
  notes               String?
  createdBy           String   @map("created_by")

  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, code], map: "uq_finance_factoring_code")
  @@index([tenantId, status], map: "idx_finance_factoring_status")
  @@map("finance_factoring_operations")
  @@schema("finance")
}
