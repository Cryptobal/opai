generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "payroll", "fx"]
}

model Tenant {
  id              String           @id @default(cuid())
  slug            String           @unique
  name            String
  active          Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  admins          Admin[]
  auditLogs       AuditLog[]
  presentations   Presentation[]
  settings        Setting[]
  templates       Template[]
  webhookSessions WebhookSession[]

  @@index([slug])
  @@index([active])
  @@schema("public")
}

model WebhookSession {
  id        String   @id @default(cuid())
  sessionId String   @unique
  zohoData  Json
  status    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([status])
  @@index([tenantId])
  @@index([tenantId, createdAt])
  @@schema("public")
}

model Template {
  id            String         @id @default(cuid())
  name          String
  slug          String         @unique
  description   String?
  type          String
  category      String?
  active        Boolean        @default(true)
  isDefault     Boolean        @default(false)
  thumbnailUrl  String?
  createdBy     String?
  lastEditedBy  String?
  usageCount    Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  tenantId      String
  presentations Presentation[]
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([slug])
  @@index([active])
  @@index([type])
  @@index([tenantId])
  @@index([tenantId, active])
  @@schema("public")
}

model Presentation {
  id               String             @id @default(cuid())
  uniqueId         String             @unique
  templateId       String
  clientData       Json
  renderedContent  Json?
  status           String             @default("draft")
  recipientEmail   String?
  recipientName    String?
  emailSentAt      DateTime?
  emailProvider    String?
  emailMessageId   String?
  whatsappSharedAt DateTime?
  whatsappNumber   String?
  viewCount        Int                @default(0)
  firstViewedAt    DateTime?
  lastViewedAt     DateTime?
  expiresAt        DateTime?
  notes            String?
  tags             String[]
  createdBy        String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  ccEmails         String[]           @default([])
  clickCount       Int                @default(0)
  deliveredAt      DateTime?
  firstOpenedAt    DateTime?
  lastClickedAt    DateTime?
  lastOpenedAt     DateTime?
  openCount        Int                @default(0)
  tenantId         String
  template         Template           @relation(fields: [templateId], references: [id])
  tenant           Tenant             @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  views            PresentationView[]

  @@index([uniqueId])
  @@index([status])
  @@index([createdAt])
  @@index([templateId])
  @@index([recipientEmail])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@schema("public")
}

model PresentationView {
  id             String       @id @default(cuid())
  presentationId String
  ipAddress      String?
  userAgent      String?
  country        String?
  city           String?
  device         String?
  browser        String?
  viewedAt       DateTime     @default(now())
  duration       Int?
  sessionId      String?
  presentation   Presentation @relation(fields: [presentationId], references: [id], onDelete: Cascade)

  @@index([presentationId])
  @@index([viewedAt])
  @@index([sessionId])
  @@schema("public")
}

model Admin {
  id          String    @id @default(cuid())
  email       String    @unique
  password    String
  name        String
  role        String    @default("admin")
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  tenantId    String
  status      String    @default("active")
  invitedBy   String?
  invitedAt   DateTime?
  activatedAt DateTime?
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([status])
  @@index([tenantId])
  @@index([tenantId, status])
  @@schema("public")
}

model UserInvitation {
  id         String    @id @default(cuid())
  email      String
  role       String
  tenantId   String
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  revokedAt  DateTime?
  invitedBy  String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([token])
  @@index([email])
  @@index([tenantId])
  @@index([expiresAt])
  @@index([tenantId, email])
  @@schema("public")
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  email     String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@schema("public")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  userEmail String?
  action    String
  entity    String
  entityId  String?
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@index([tenantId])
  @@schema("public")
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  type      String
  category  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  @@index([key])
  @@index([category])
  @@index([tenantId])
  @@schema("public")
}

// ============================================
// FX MODULE (Financial Rates)
// ============================================

model FxUfRate {
  date      DateTime @id @db.Date
  value     Decimal  @db.Decimal(10, 2)
  fetchedAt DateTime @default(now()) @map("fetched_at") @db.Timestamptz(6)
  source    String?  @default("SBIF")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([date(sort: Desc)], map: "idx_uf_rates_date_desc")
  @@index([fetchedAt(sort: Desc)], map: "idx_uf_rates_fetched")
  @@map("uf_rates")
  @@schema("fx")
}

model FxUtmRate {
  month     DateTime @id @db.Date
  value     Decimal  @db.Decimal(10, 2)
  fetchedAt DateTime @default(now()) @map("fetched_at") @db.Timestamptz(6)
  source    String?  @default("SII")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([month(sort: Desc)], map: "idx_utm_rates_month_desc")
  @@index([fetchedAt(sort: Desc)], map: "idx_utm_rates_fetched")
  @@map("utm_rates")
  @@schema("fx")
}

// ============================================
// PAYROLL MODULE
// ============================================

model PayrollParameterVersion {
  id             String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name           String
  description    String?
  effectiveFrom  DateTime @map("effective_from") @db.Date
  effectiveUntil DateTime? @map("effective_until") @db.Date
  data           Json     @db.JsonB
  isActive       Boolean  @default(false) @map("is_active")
  createdBy      String?  @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  simulations PayrollSimulation[]

  @@index([effectiveFrom(sort: Desc)], map: "idx_param_versions_effective")
  @@index([isActive], map: "idx_param_versions_active")
  @@index([effectiveFrom, effectiveUntil], map: "idx_param_versions_dates")
  @@map("parameter_versions")
  @@schema("payroll")
}

model PayrollAssumption {
  id                       String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                     String
  description              String?
  vacationProvisionPct     Decimal  @default(0.0833) @map("vacation_provision_pct") @db.Decimal(5, 4)
  severanceProvisionPct    Decimal  @default(0.0000) @map("severance_provision_pct") @db.Decimal(5, 4)
  holidayBonusPct          Decimal  @default(0.0000) @map("holiday_bonus_pct") @db.Decimal(5, 4)
  christmasBonusPct        Decimal  @default(0.0000) @map("christmas_bonus_pct") @db.Decimal(5, 4)
  workInjuryBasicRate      Decimal? @map("work_injury_basic_rate") @db.Decimal(6, 5)
  workInjuryAdditionalRate Decimal? @map("work_injury_additional_rate") @db.Decimal(6, 5)
  workInjuryExtraRate      Decimal? @map("work_injury_extra_rate") @db.Decimal(6, 5)
  workInjuryTotalRate      Decimal? @map("work_injury_total_rate") @db.Decimal(6, 5)
  workInjuryRiskLevel      String   @default("medium") @map("work_injury_risk_level")
  isDefault                Boolean  @default(false) @map("is_default")
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  simulations PayrollSimulation[]

  @@index([isDefault], map: "idx_assumptions_default")
  @@map("assumptions")
  @@schema("payroll")
}

model PayrollSimulation {
  id                  String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  simulationType      String   @map("simulation_type")
  paramsVersionId     String   @map("params_version_id") @db.Uuid
  assumptionsId       String?  @map("assumptions_id") @db.Uuid
  inputs              Json     @db.JsonB
  results             Json     @db.JsonB
  parametersSnapshot  Json     @map("parameters_snapshot") @db.JsonB
  createdByUserId     String?  @map("created_by_user_id")
  tenantId            String?  @map("tenant_id")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  clientInfo          Json?    @map("client_info") @db.JsonB

  parameterVersion PayrollParameterVersion @relation(fields: [paramsVersionId], references: [id])
  assumptions      PayrollAssumption?      @relation(fields: [assumptionsId], references: [id])

  @@index([simulationType], map: "idx_simulations_type")
  @@index([createdAt(sort: Desc)], map: "idx_simulations_created_at")
  @@index([createdByUserId], map: "idx_simulations_user")
  @@index([tenantId], map: "idx_simulations_tenant")
  @@index([paramsVersionId], map: "idx_simulations_params_version")
  @@map("simulations")
  @@schema("payroll")
}

model PayrollSalaryComponent {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  code          String   @unique
  name          String
  description   String?
  componentType String   @map("component_type")
  isTaxable     Boolean  @default(true) @map("is_taxable")
  isTributable  Boolean  @default(true) @map("is_tributable")
  isActive      Boolean  @default(true) @map("is_active")
  displayOrder  Int?     @map("display_order")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([componentType], map: "idx_components_type")
  @@index([isActive], map: "idx_components_active")
  @@index([code], map: "idx_components_code")
  @@map("salary_components_catalog")
  @@schema("payroll")
}
