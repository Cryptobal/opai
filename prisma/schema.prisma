generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "payroll", "fx", "cpq", "crm", "docs"]
}

model Tenant {
  id              String           @id @default(cuid())
  slug            String           @unique
  name            String
  active          Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  admins          Admin[]
  auditLogs       AuditLog[]
  presentations   Presentation[]
  settings        Setting[]
  templates       Template[]
  webhookSessions WebhookSession[]

  @@index([slug])
  @@index([active])
  @@schema("public")
}

model WebhookSession {
  id        String   @id @default(cuid())
  sessionId String   @unique
  zohoData  Json
  status    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([status])
  @@index([tenantId])
  @@index([tenantId, createdAt])
  @@schema("public")
}

model Template {
  id            String         @id @default(cuid())
  name          String
  slug          String         @unique
  description   String?
  type          String
  category      String?
  active        Boolean        @default(true)
  isDefault     Boolean        @default(false)
  thumbnailUrl  String?
  createdBy     String?
  lastEditedBy  String?
  usageCount    Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  tenantId      String
  presentations Presentation[]
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([slug])
  @@index([active])
  @@index([type])
  @@index([tenantId])
  @@index([tenantId, active])
  @@schema("public")
}

model Presentation {
  id               String             @id @default(cuid())
  uniqueId         String             @unique
  templateId       String
  clientData       Json
  renderedContent  Json?
  status           String             @default("draft")
  recipientEmail   String?
  recipientName    String?
  emailSentAt      DateTime?
  emailProvider    String?
  emailMessageId   String?
  whatsappSharedAt DateTime?
  whatsappNumber   String?
  viewCount        Int                @default(0)
  firstViewedAt    DateTime?
  lastViewedAt     DateTime?
  expiresAt        DateTime?
  notes            String?
  tags             String[]
  createdBy        String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  ccEmails         String[]           @default([])
  clickCount       Int                @default(0)
  deliveredAt      DateTime?
  firstOpenedAt    DateTime?
  lastClickedAt    DateTime?
  lastOpenedAt     DateTime?
  openCount        Int                @default(0)
  tenantId         String
  quoteId          String?            @map("quote_id") // Links to CpqQuote for document generation
  template         Template           @relation(fields: [templateId], references: [id])
  tenant           Tenant             @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  views            PresentationView[]

  @@index([uniqueId])
  @@index([status])
  @@index([createdAt])
  @@index([templateId])
  @@index([recipientEmail])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@schema("public")
}

model PresentationView {
  id             String       @id @default(cuid())
  presentationId String
  ipAddress      String?
  userAgent      String?
  country        String?
  city           String?
  device         String?
  browser        String?
  viewedAt       DateTime     @default(now())
  duration       Int?
  sessionId      String?
  presentation   Presentation @relation(fields: [presentationId], references: [id], onDelete: Cascade)

  @@index([presentationId])
  @@index([viewedAt])
  @@index([sessionId])
  @@schema("public")
}

model Admin {
  id          String    @id @default(cuid())
  email       String    @unique
  password    String
  name        String
  role        String    @default("admin")
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  tenantId    String
  status      String    @default("active")
  invitedBy   String?
  invitedAt   DateTime?
  activatedAt DateTime?
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([status])
  @@index([tenantId])
  @@index([tenantId, status])
  @@schema("public")
}

model UserInvitation {
  id         String    @id @default(cuid())
  email      String
  role       String
  tenantId   String
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  revokedAt  DateTime?
  invitedBy  String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([token])
  @@index([email])
  @@index([tenantId])
  @@index([expiresAt])
  @@index([tenantId, email])
  @@schema("public")
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  email     String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@schema("public")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  userEmail String?
  action    String
  entity    String
  entityId  String?
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@index([tenantId])
  @@schema("public")
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  type      String
  category  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  @@index([key])
  @@index([category])
  @@index([tenantId])
  @@schema("public")
}

// ============================================
// FX MODULE (Financial Rates)
// ============================================

model FxUfRate {
  date      DateTime @id @db.Date
  value     Decimal  @db.Decimal(10, 2)
  fetchedAt DateTime @default(now()) @map("fetched_at") @db.Timestamptz(6)
  source    String?  @default("SBIF")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([date(sort: Desc)], map: "idx_uf_rates_date_desc")
  @@index([fetchedAt(sort: Desc)], map: "idx_uf_rates_fetched")
  @@map("uf_rates")
  @@schema("fx")
}

model FxUtmRate {
  month     DateTime @id @db.Date
  value     Decimal  @db.Decimal(10, 2)
  fetchedAt DateTime @default(now()) @map("fetched_at") @db.Timestamptz(6)
  source    String?  @default("SII")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([month(sort: Desc)], map: "idx_utm_rates_month_desc")
  @@index([fetchedAt(sort: Desc)], map: "idx_utm_rates_fetched")
  @@map("utm_rates")
  @@schema("fx")
}

// ============================================
// PAYROLL MODULE
// ============================================

model PayrollParameterVersion {
  id             String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name           String
  description    String?
  effectiveFrom  DateTime @map("effective_from") @db.Date
  effectiveUntil DateTime? @map("effective_until") @db.Date
  data           Json     @db.JsonB
  isActive       Boolean  @default(false) @map("is_active")
  createdBy      String?  @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  simulations PayrollSimulation[]

  @@index([effectiveFrom(sort: Desc)], map: "idx_param_versions_effective")
  @@index([isActive], map: "idx_param_versions_active")
  @@index([effectiveFrom, effectiveUntil], map: "idx_param_versions_dates")
  @@map("parameter_versions")
  @@schema("payroll")
}

model PayrollAssumption {
  id                       String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                     String
  description              String?
  vacationProvisionPct     Decimal  @default(0.0833) @map("vacation_provision_pct") @db.Decimal(5, 4)
  severanceProvisionPct    Decimal  @default(0.0000) @map("severance_provision_pct") @db.Decimal(5, 4)
  holidayBonusPct          Decimal  @default(0.0000) @map("holiday_bonus_pct") @db.Decimal(5, 4)
  christmasBonusPct        Decimal  @default(0.0000) @map("christmas_bonus_pct") @db.Decimal(5, 4)
  workInjuryBasicRate      Decimal? @map("work_injury_basic_rate") @db.Decimal(6, 5)
  workInjuryAdditionalRate Decimal? @map("work_injury_additional_rate") @db.Decimal(6, 5)
  workInjuryExtraRate      Decimal? @map("work_injury_extra_rate") @db.Decimal(6, 5)
  workInjuryTotalRate      Decimal? @map("work_injury_total_rate") @db.Decimal(6, 5)
  workInjuryRiskLevel      String   @default("medium") @map("work_injury_risk_level")
  isDefault                Boolean  @default(false) @map("is_default")
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  simulations PayrollSimulation[]

  @@index([isDefault], map: "idx_assumptions_default")
  @@map("assumptions")
  @@schema("payroll")
}

model PayrollSimulation {
  id                  String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  simulationType      String   @map("simulation_type")
  paramsVersionId     String   @map("params_version_id") @db.Uuid
  assumptionsId       String?  @map("assumptions_id") @db.Uuid
  inputs              Json     @db.JsonB
  results             Json     @db.JsonB
  parametersSnapshot  Json     @map("parameters_snapshot") @db.JsonB
  createdByUserId     String?  @map("created_by_user_id")
  tenantId            String?  @map("tenant_id")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  clientInfo          Json?    @map("client_info") @db.JsonB

  parameterVersion PayrollParameterVersion @relation(fields: [paramsVersionId], references: [id])
  assumptions      PayrollAssumption?      @relation(fields: [assumptionsId], references: [id])

  @@index([simulationType], map: "idx_simulations_type")
  @@index([createdAt(sort: Desc)], map: "idx_simulations_created_at")
  @@index([createdByUserId], map: "idx_simulations_user")
  @@index([tenantId], map: "idx_simulations_tenant")
  @@index([paramsVersionId], map: "idx_simulations_params_version")
  @@map("simulations")
  @@schema("payroll")
}

model PayrollSalaryComponent {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  code          String   @unique
  name          String
  description   String?
  componentType String   @map("component_type")
  isTaxable     Boolean  @default(true) @map("is_taxable")
  isTributable  Boolean  @default(true) @map("is_tributable")
  isActive      Boolean  @default(true) @map("is_active")
  displayOrder  Int?     @map("display_order")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([componentType], map: "idx_components_type")
  @@index([isActive], map: "idx_components_active")
  @@index([code], map: "idx_components_code")
  @@map("salary_components_catalog")
  @@schema("payroll")
}

// ============================================
// CPQ MODULE (Configure, Price, Quote)
// ============================================

model CpqQuote {
  id               String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId         String        @map("tenant_id")
  code             String        @unique @map("code")
  status           String        @default("draft")
  clientName       String?       @map("client_name")
  validUntil       DateTime?     @map("valid_until") @db.Date
  notes            String?
  totalPositions   Int           @default(0) @map("total_positions")
  totalGuards      Int           @default(0) @map("total_guards")
  monthlyCost      Decimal       @default(0) @map("monthly_cost") @db.Decimal(12, 2)
  // CRM context (optional - a quote can exist without CRM)
  accountId        String?       @map("account_id") @db.Uuid
  contactId        String?       @map("contact_id") @db.Uuid
  dealId           String?       @map("deal_id") @db.Uuid
  installationId   String?       @map("installation_id") @db.Uuid
  // Currency & AI
  currency         String        @default("CLP") // "CLP" | "UF"
  aiDescription    String?       @map("ai_description")
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  positions        CpqPosition[]
  parameters       CpqQuoteParameters?
  uniformItems     CpqQuoteUniformItem[]
  examItems        CpqQuoteExamItem[]
  costItems        CpqQuoteCostItem[]
  meals            CpqQuoteMeal[]
  vehicles         CpqQuoteVehicle[]
  infrastructure   CpqQuoteInfrastructure[]
  installation     CrmInstallation? @relation(fields: [installationId], references: [id], onDelete: SetNull)

  @@index([tenantId], map: "idx_cpq_quotes_tenant")
  @@index([status], map: "idx_cpq_quotes_status")
  @@index([createdAt(sort: Desc)], map: "idx_cpq_quotes_created_desc")
  @@index([accountId], map: "idx_cpq_quotes_account")
  @@index([dealId], map: "idx_cpq_quotes_deal")
  @@index([installationId], map: "idx_cpq_quotes_installation")
  @@map("quotes")
  @@schema("cpq")
}

model CpqPosition {
  id                  String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId             String   @map("quote_id") @db.Uuid
  puestoTrabajoId     String   @map("puesto_trabajo_id") @db.Uuid
  customName          String?  @map("custom_name")
  description         String?
  weekdays            String[] @map("weekdays")
  startTime           String   @map("start_time")
  endTime             String   @map("end_time")
  numGuards           Int      @default(1) @map("num_guards")
  cargoId             String   @map("cargo_id") @db.Uuid
  rolId               String   @map("rol_id") @db.Uuid
  baseSalary          Decimal  @map("base_salary") @db.Decimal(12, 2)
  afpName             String   @default("modelo") @map("afp_name")
  healthSystem        String   @default("fonasa") @map("health_system")
  healthPlanPct       Decimal? @map("health_plan_pct") @db.Decimal(5, 4)
  employerCost        Decimal  @map("employer_cost") @db.Decimal(12, 2)
  netSalary           Decimal? @map("net_salary") @db.Decimal(12, 2)
  monthlyPositionCost Decimal  @default(0) @map("monthly_position_cost") @db.Decimal(12, 2)
  payrollSnapshot     Json?    @map("payroll_snapshot") @db.JsonB
  payrollVersionId    String?  @map("payroll_version_id") @db.Uuid
  calculatedAt        DateTime? @map("calculated_at") @db.Timestamptz(6)
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quote         CpqQuote        @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  puestoTrabajo CpqPuestoTrabajo @relation(fields: [puestoTrabajoId], references: [id])
  cargo         CpqCargo        @relation(fields: [cargoId], references: [id])
  rol           CpqRol          @relation(fields: [rolId], references: [id])

  @@index([quoteId], map: "idx_cpq_positions_quote")
  @@index([puestoTrabajoId], map: "idx_cpq_positions_puesto")
  @@index([cargoId], map: "idx_cpq_positions_cargo")
  @@index([rolId], map: "idx_cpq_positions_rol")
  @@map("positions")
  @@schema("cpq")
}

model CpqPuestoTrabajo {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String   @unique
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  positions CpqPosition[]

  @@index([active], map: "idx_cpq_puestos_active")
  @@map("puestos_trabajo")
  @@schema("cpq")
}

model CpqCargo {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String   @unique
  description String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  positions CpqPosition[]

  @@index([active], map: "idx_cpq_cargos_active")
  @@map("cargos")
  @@schema("cpq")
}

model CpqRol {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String   @unique
  description String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  positions CpqPosition[]

  @@index([active], map: "idx_cpq_roles_active")
  @@map("roles")
  @@schema("cpq")
}

model CpqCatalogItem {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId          String?  @map("tenant_id")
  type              String
  name              String
  unit              String
  basePrice         Decimal  @default(0) @map("base_price") @db.Decimal(12, 2)
  isDefault         Boolean  @default(false) @map("is_default")
  defaultVisibility String   @default("visible") @map("default_visibility")
  active            Boolean  @default(true)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  uniformSelections CpqQuoteUniformItem[]
  examSelections    CpqQuoteExamItem[]
  costItems         CpqQuoteCostItem[]

  @@index([type], map: "idx_cpq_catalog_type")
  @@index([active], map: "idx_cpq_catalog_active")
  @@index([tenantId], map: "idx_cpq_catalog_tenant")
  @@index([tenantId, type], map: "idx_cpq_catalog_tenant_type")
  @@map("catalog_items")
  @@schema("cpq")
}

model CpqQuoteParameters {
  id                     String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId                String   @unique @map("quote_id") @db.Uuid
  monthlyHoursStandard   Int      @default(180) @map("monthly_hours_standard")
  avgStayMonths          Int      @default(4) @map("avg_stay_months")
  uniformChangesPerYear  Int      @default(3) @map("uniform_changes_per_year")
  financialRatePct       Decimal  @default(0) @map("financial_rate_pct") @db.Decimal(6, 4)
  salePriceMonthly       Decimal  @default(0) @map("sale_price_monthly") @db.Decimal(12, 2)
  policyRatePct          Decimal  @default(0) @map("policy_rate_pct") @db.Decimal(6, 4)
  policyAdminRatePct     Decimal  @default(0) @map("policy_admin_rate_pct") @db.Decimal(6, 4)
  policyContractMonths   Int      @default(12) @map("policy_contract_months")
  policyContractPct      Decimal  @default(100) @map("policy_contract_pct") @db.Decimal(6, 2)
  contractMonths         Int      @default(12) @map("contract_months")
  contractAmount         Decimal  @default(0) @map("contract_amount") @db.Decimal(14, 2)
  marginPct              Decimal  @default(20) @map("margin_pct") @db.Decimal(6, 2)
  createdAt              DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quote CpqQuote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@map("quote_parameters")
  @@schema("cpq")
}

model CpqQuoteUniformItem {
  id               String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId          String   @map("quote_id") @db.Uuid
  catalogItemId    String   @map("catalog_item_id") @db.Uuid
  unitPriceOverride Decimal? @map("unit_price_override") @db.Decimal(12, 2)
  active           Boolean  @default(true)
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quote       CpqQuote       @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  catalogItem CpqCatalogItem @relation(fields: [catalogItemId], references: [id])

  @@index([quoteId], map: "idx_cpq_uniform_quote")
  @@index([catalogItemId], map: "idx_cpq_uniform_catalog")
  @@map("quote_uniform_items")
  @@schema("cpq")
}

model CpqQuoteExamItem {
  id               String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId          String   @map("quote_id") @db.Uuid
  catalogItemId    String   @map("catalog_item_id") @db.Uuid
  unitPriceOverride Decimal? @map("unit_price_override") @db.Decimal(12, 2)
  active           Boolean  @default(true)
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quote       CpqQuote       @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  catalogItem CpqCatalogItem @relation(fields: [catalogItemId], references: [id])

  @@index([quoteId], map: "idx_cpq_exam_quote")
  @@index([catalogItemId], map: "idx_cpq_exam_catalog")
  @@map("quote_exam_items")
  @@schema("cpq")
}

model CpqQuoteCostItem {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId           String   @map("quote_id") @db.Uuid
  catalogItemId     String   @map("catalog_item_id") @db.Uuid
  calcMode          String   @default("per_month") @map("calc_mode")
  quantity          Decimal  @default(1) @db.Decimal(12, 2)
  unitPriceOverride Decimal? @map("unit_price_override") @db.Decimal(12, 2)
  isEnabled         Boolean  @default(true) @map("is_enabled")
  visibility        String   @default("visible")
  notes             String?
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quote       CpqQuote       @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  catalogItem CpqCatalogItem @relation(fields: [catalogItemId], references: [id])

  @@index([quoteId], map: "idx_cpq_cost_quote")
  @@index([catalogItemId], map: "idx_cpq_cost_catalog")
  @@index([isEnabled], map: "idx_cpq_cost_enabled")
  @@map("quote_cost_items")
  @@schema("cpq")
}

model CpqQuoteMeal {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId       String   @map("quote_id") @db.Uuid
  mealType      String   @map("meal_type")
  mealsPerDay   Int      @default(0) @map("meals_per_day")
  daysOfService Int      @default(0) @map("days_of_service")
  priceOverride Decimal? @map("price_override") @db.Decimal(12, 2)
  isEnabled     Boolean  @default(true) @map("is_enabled")
  visibility    String   @default("visible")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quote CpqQuote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId], map: "idx_cpq_meals_quote")
  @@map("quote_meals")
  @@schema("cpq")
}

model CpqQuoteVehicle {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId           String   @map("quote_id") @db.Uuid
  vehiclesCount     Int      @default(1) @map("vehicles_count")
  rentMonthly       Decimal  @default(0) @map("rent_monthly") @db.Decimal(12, 2)
  kmPerDay          Decimal  @default(0) @map("km_per_day") @db.Decimal(10, 2)
  daysPerMonth      Int      @default(0) @map("days_per_month")
  kmPerLiter        Decimal  @default(0) @map("km_per_liter") @db.Decimal(10, 2)
  fuelPrice         Decimal  @default(0) @map("fuel_price") @db.Decimal(12, 2)
  maintenanceMonthly Decimal @default(0) @map("maintenance_monthly") @db.Decimal(12, 2)
  isEnabled         Boolean  @default(true) @map("is_enabled")
  visibility        String   @default("visible")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quote CpqQuote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId], map: "idx_cpq_vehicles_quote")
  @@map("quote_vehicles")
  @@schema("cpq")
}

model CpqQuoteInfrastructure {
  id                 String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId            String   @map("quote_id") @db.Uuid
  itemType           String   @map("item_type")
  quantity           Int      @default(1)
  rentMonthly        Decimal  @default(0) @map("rent_monthly") @db.Decimal(12, 2)
  hasFuel            Boolean  @default(false) @map("has_fuel")
  fuelLitersPerHour  Decimal  @default(0) @map("fuel_liters_per_hour") @db.Decimal(10, 2)
  fuelHoursPerDay    Decimal  @default(0) @map("fuel_hours_per_day") @db.Decimal(10, 2)
  fuelDaysPerMonth   Int      @default(0) @map("fuel_days_per_month")
  fuelPrice          Decimal  @default(0) @map("fuel_price") @db.Decimal(12, 2)
  isEnabled          Boolean  @default(true) @map("is_enabled")
  visibility         String   @default("visible")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  quote CpqQuote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId], map: "idx_cpq_infra_quote")
  @@map("quote_infrastructure")
  @@schema("cpq")
}

// ============================================
// CRM MODULE (Leads, Accounts, Deals, Email)
// ============================================

model CrmLead {
  id                 String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId           String    @map("tenant_id")
  status             String    @default("pending")
  source             String?
  firstName          String?   @map("first_name")
  lastName           String?   @map("last_name")
  email              String?
  phone              String?
  companyName        String?   @map("company_name")
  notes              String?
  industry           String?
  address            String?
  commune            String?
  city               String?
  website            String?
  serviceType        String?   @map("service_type")
  metadata           Json?     @db.JsonB
  approvedAt         DateTime? @map("approved_at") @db.Timestamptz(6)
  approvedBy         String?   @map("approved_by")
  convertedAccountId String?   @map("converted_account_id") @db.Uuid
  convertedContactId String?   @map("converted_contact_id") @db.Uuid
  convertedDealId    String?   @map("converted_deal_id") @db.Uuid
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  leadInstallations CrmInstallation[]

  @@index([tenantId], map: "idx_crm_leads_tenant")
  @@index([status], map: "idx_crm_leads_status")
  @@index([createdAt(sort: Desc)], map: "idx_crm_leads_created_desc")
  @@map("leads")
  @@schema("crm")
}

model Notification {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  type      String   // "new_lead", "lead_approved", "quote_sent", etc.
  title     String
  message   String?
  data      Json?    @db.JsonB
  read      Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([tenantId], map: "idx_notifications_tenant")
  @@index([tenantId, read], map: "idx_notifications_tenant_read")
  @@index([createdAt(sort: Desc)], map: "idx_notifications_created_desc")
  @@map("notifications")
  @@schema("crm")
}

model CrmIndustry {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name      String   @unique
  order     Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([active], map: "idx_crm_industries_active")
  @@map("industries")
  @@schema("crm")
}

model CrmAccount {
  id                      String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId                String   @map("tenant_id")
  name                    String
  rut                     String?
  legalName              String?  @map("legal_name") // Razón social
  legalRepresentativeName String?  @map("legal_representative_name")
  legalRepresentativeRut  String?  @map("legal_representative_rut")
  industry                String?
  size                    String?
  segment                 String?
  ownerId                 String?  @map("owner_id")
  type                    String   @default("prospect") // "prospect" | "client"
  status                  String   @default("active")
  website                 String?
  address                 String?
  notes                   String?
  createdAt               DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  contacts      CrmContact[]
  deals         CrmDeal[]
  installations CrmInstallation[]

  @@index([tenantId], map: "idx_crm_accounts_tenant")
  @@index([status], map: "idx_crm_accounts_status")
  @@index([tenantId, type], map: "idx_crm_accounts_type")
  @@index([createdAt(sort: Desc)], map: "idx_crm_accounts_created_desc")
  @@map("accounts")
  @@schema("crm")
}

model CrmInstallation {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  accountId String?  @map("account_id") @db.Uuid
  leadId    String?  @map("lead_id") @db.Uuid
  name      String
  address   String?
  city      String?
  commune   String?
  lat       Float?
  lng       Float?
  notes     String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  account CrmAccount? @relation(fields: [accountId], references: [id], onDelete: Cascade)
  lead    CrmLead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)
  quotes  CpqQuote[]

  @@index([tenantId], map: "idx_crm_installations_tenant")
  @@index([accountId], map: "idx_crm_installations_account")
  @@index([leadId], map: "idx_crm_installations_lead")
  @@map("installations")
  @@schema("crm")
}

model CrmContact {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId   String   @map("tenant_id")
  accountId  String   @map("account_id") @db.Uuid
  firstName  String   @map("first_name")
  lastName   String   @map("last_name")
  email      String?
  phone      String?
  roleTitle  String?  @map("role_title")
  isPrimary  Boolean  @default(false) @map("is_primary")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  account      CrmAccount       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  deals        CrmDeal[]        @relation("crm_deal_primary_contact")
  dealContacts CrmDealContact[]

  @@index([tenantId], map: "idx_crm_contacts_tenant")
  @@index([accountId], map: "idx_crm_contacts_account")
  @@index([createdAt(sort: Desc)], map: "idx_crm_contacts_created_desc")
  @@map("contacts")
  @@schema("crm")
}

model CrmDealContact {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  dealId    String   @map("deal_id") @db.Uuid
  contactId String   @map("contact_id") @db.Uuid
  role      String   @default("participant") // primary, participant, decision_maker
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  deal    CrmDeal    @relation(fields: [dealId], references: [id], onDelete: Cascade)
  contact CrmContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([dealId, contactId], map: "uq_crm_deal_contact")
  @@index([dealId], map: "idx_crm_deal_contacts_deal")
  @@index([contactId], map: "idx_crm_deal_contacts_contact")
  @@map("deal_contacts")
  @@schema("crm")
}

model CrmPipelineStage {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId     String   @map("tenant_id")
  name         String
  order        Int
  color        String?
  isActive     Boolean  @default(true) @map("is_active")
  isClosedWon  Boolean  @default(false) @map("is_closed_won")
  isClosedLost Boolean  @default(false) @map("is_closed_lost")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  deals        CrmDeal[]
  historyFrom  CrmDealStageHistory[] @relation("crm_history_from_stage")
  historyTo    CrmDealStageHistory[] @relation("crm_history_to_stage")

  @@index([tenantId], map: "idx_crm_pipeline_tenant")
  @@index([isActive], map: "idx_crm_pipeline_active")
  @@index([order], map: "idx_crm_pipeline_order")
  @@unique([tenantId, name], map: "uq_crm_pipeline_tenant_name")
  @@map("pipeline_stages")
  @@schema("crm")
}

model CrmDeal {
  id                   String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId             String    @map("tenant_id")
  accountId            String    @map("account_id") @db.Uuid
  primaryContactId     String?   @map("primary_contact_id") @db.Uuid
  title                String
  amount               Decimal   @default(0) @db.Decimal(14, 2)
  stageId              String    @map("stage_id") @db.Uuid
  probability          Int       @default(0)
  expectedCloseDate    DateTime?  @map("expected_close_date") @db.Date
  status               String    @default("open")
  lostReason           String?   @map("lost_reason")
  // Campos adicionales migración Soho CRM
  proposalLink        String?   @map("proposal_link") // Link a propuesta PandaDoc
  proposalSentAt      DateTime? @map("proposal_sent_at") @db.Date
  dealType            String?   @map("deal_type") // newbusiness, Cotización, Wherex, Licitación
  notes               String?
  driveFolderLink     String?   @map("drive_folder_link")
  installationName    String?   @map("installation_name")
  technicalVisitDate  DateTime? @map("technical_visit_date") @db.Date
  service             String?
  street              String?
  address             String?
  city                String?
  commune             String?
  lat                 Float?
  lng                 Float?
  installationWebsite String?   @map("installation_website")
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  account        CrmAccount       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  primaryContact CrmContact?      @relation("crm_deal_primary_contact", fields: [primaryContactId], references: [id], onDelete: SetNull)
  stage          CrmPipelineStage @relation(fields: [stageId], references: [id])
  stageHistory   CrmDealStageHistory[]
  quotes         CrmDealQuote[]
  tasks          CrmTask[]
  followUpLogs   CrmFollowUpLog[]
  dealContacts   CrmDealContact[]

  @@index([tenantId], map: "idx_crm_deals_tenant")
  @@index([status], map: "idx_crm_deals_status")
  @@index([stageId], map: "idx_crm_deals_stage")
  @@index([accountId], map: "idx_crm_deals_account")
  @@index([createdAt(sort: Desc)], map: "idx_crm_deals_created_desc")
  @@map("deals")
  @@schema("crm")
}

model CrmDealStageHistory {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id")
  dealId      String   @map("deal_id") @db.Uuid
  fromStageId String?  @map("from_stage_id") @db.Uuid
  toStageId   String   @map("to_stage_id") @db.Uuid
  changedBy   String?  @map("changed_by")
  changedAt   DateTime @default(now()) @map("changed_at") @db.Timestamptz(6)

  deal      CrmDeal          @relation(fields: [dealId], references: [id], onDelete: Cascade)
  fromStage CrmPipelineStage? @relation("crm_history_from_stage", fields: [fromStageId], references: [id])
  toStage   CrmPipelineStage  @relation("crm_history_to_stage", fields: [toStageId], references: [id])

  @@index([tenantId], map: "idx_crm_deal_stage_tenant")
  @@index([dealId], map: "idx_crm_deal_stage_deal")
  @@index([changedAt(sort: Desc)], map: "idx_crm_deal_stage_changed_desc")
  @@map("deal_stage_history")
  @@schema("crm")
}

model CrmDealQuote {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  dealId    String   @map("deal_id") @db.Uuid
  quoteId   String   @map("quote_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  deal CrmDeal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_crm_deal_quotes_tenant")
  @@index([dealId], map: "idx_crm_deal_quotes_deal")
  @@index([quoteId], map: "idx_crm_deal_quotes_quote")
  @@unique([dealId, quoteId], map: "uq_crm_deal_quote")
  @@map("deal_quotes")
  @@schema("crm")
}

model CrmTask {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId   String   @map("tenant_id")
  dealId     String?  @map("deal_id") @db.Uuid
  leadId     String?  @map("lead_id") @db.Uuid
  title      String
  status     String   @default("open")
  type       String   @default("followup")
  dueAt      DateTime? @map("due_at") @db.Timestamptz(6)
  assignedTo String?  @map("assigned_to")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  deal CrmDeal? @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_crm_tasks_tenant")
  @@index([status], map: "idx_crm_tasks_status")
  @@index([dueAt], map: "idx_crm_tasks_due")
  @@index([dealId], map: "idx_crm_tasks_deal")
  @@map("tasks")
  @@schema("crm")
}

model CrmEmailAccount {
  id                   String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId             String   @map("tenant_id")
  userId               String   @map("user_id")
  provider             String
  email                String
  accessTokenEncrypted String?  @map("access_token_encrypted")
  refreshTokenEncrypted String? @map("refresh_token_encrypted")
  tokenExpiresAt       DateTime? @map("token_expires_at") @db.Timestamptz(6)
  status               String   @default("active")
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([tenantId], map: "idx_crm_email_accounts_tenant")
  @@index([userId], map: "idx_crm_email_accounts_user")
  @@index([provider], map: "idx_crm_email_accounts_provider")
  @@map("email_accounts")
  @@schema("crm")
}

model CrmEmailThread {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String   @map("tenant_id")
  accountId     String?  @map("account_id") @db.Uuid
  contactId     String?  @map("contact_id") @db.Uuid
  dealId        String?  @map("deal_id") @db.Uuid
  subject       String
  lastMessageAt DateTime? @map("last_message_at") @db.Timestamptz(6)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  messages CrmEmailMessage[]

  @@index([tenantId], map: "idx_crm_email_threads_tenant")
  @@index([accountId], map: "idx_crm_email_threads_account")
  @@index([dealId], map: "idx_crm_email_threads_deal")
  @@map("email_threads")
  @@schema("crm")
}

model CrmEmailMessage {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId          String   @map("tenant_id")
  threadId          String   @map("thread_id") @db.Uuid
  providerMessageId String?  @map("provider_message_id")
  direction         String   @default("out")
  fromEmail         String   @map("from_email")
  toEmails          String[] @map("to_emails")
  ccEmails          String[] @default([]) @map("cc_emails")
  bccEmails         String[] @default([]) @map("bcc_emails")
  subject           String
  htmlBody          String?  @map("html_body")
  textBody          String?  @map("text_body")
  sentAt            DateTime? @map("sent_at") @db.Timestamptz(6)
  receivedAt        DateTime? @map("received_at") @db.Timestamptz(6)
  createdBy         String?  @map("created_by")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // ── Tracking fields ──
  resendId        String?   @map("resend_id")
  status          String    @default("queued") @map("email_status") // queued, sent, delivered, opened, clicked, bounced, complained
  deliveredAt     DateTime? @map("delivered_at") @db.Timestamptz(6)
  firstOpenedAt   DateTime? @map("first_opened_at") @db.Timestamptz(6)
  lastOpenedAt    DateTime? @map("last_opened_at") @db.Timestamptz(6)
  openCount       Int       @default(0) @map("open_count")
  firstClickedAt  DateTime? @map("first_clicked_at") @db.Timestamptz(6)
  clickCount      Int       @default(0) @map("click_count")
  bouncedAt       DateTime? @map("bounced_at") @db.Timestamptz(6)
  bounceType      String?   @map("bounce_type")

  // ── References ──
  signatureId     String?   @map("signature_id") @db.Uuid
  followUpLogId   String?   @map("followup_log_id") @db.Uuid
  source          String    @default("manual") // manual, followup, gmail

  thread CrmEmailThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_crm_email_messages_tenant")
  @@index([threadId], map: "idx_crm_email_messages_thread")
  @@index([sentAt], map: "idx_crm_email_messages_sent")
  @@index([resendId], map: "idx_crm_email_messages_resend")
  @@index([followUpLogId], map: "idx_crm_email_messages_followup")
  @@map("email_messages")
  @@schema("crm")
}

model CrmEmailTemplate {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  name      String
  subject   String
  body      String
  scope     String   @default("global")
  stageId   String?  @map("stage_id") @db.Uuid
  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([tenantId], map: "idx_crm_email_templates_tenant")
  @@index([scope], map: "idx_crm_email_templates_scope")
  @@index([stageId], map: "idx_crm_email_templates_stage")
  @@map("email_templates")
  @@schema("crm")
}

model CrmFile {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id")
  fileName        String   @map("file_name")
  mimeType        String   @map("mime_type")
  size            Int
  storageProvider String   @map("storage_provider")
  storageKey      String   @map("storage_key")
  createdBy       String?  @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  links CrmFileLink[]

  @@index([tenantId], map: "idx_crm_files_tenant")
  @@index([createdAt(sort: Desc)], map: "idx_crm_files_created_desc")
  @@map("files")
  @@schema("crm")
}

model CrmFileLink {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId   String   @map("tenant_id")
  fileId     String   @map("file_id") @db.Uuid
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  file CrmFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_crm_file_links_tenant")
  @@index([fileId], map: "idx_crm_file_links_file")
  @@index([entityType, entityId], map: "idx_crm_file_links_entity")
  @@map("file_links")
  @@schema("crm")
}

model CrmCustomField {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId   String   @map("tenant_id")
  entityType String   @map("entity_type")
  name       String
  type       String
  options    Json?
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  values CrmCustomFieldValue[]

  @@index([tenantId], map: "idx_crm_custom_fields_tenant")
  @@index([entityType], map: "idx_crm_custom_fields_entity")
  @@map("custom_fields")
  @@schema("crm")
}

model CrmCustomFieldValue {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  fieldId   String   @map("field_id") @db.Uuid
  entityId  String   @map("entity_id")
  value     Json?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  field CrmCustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "idx_crm_custom_values_tenant")
  @@index([fieldId], map: "idx_crm_custom_values_field")
  @@index([entityId], map: "idx_crm_custom_values_entity")
  @@map("custom_field_values")
  @@schema("crm")
}

model CrmHistoryLog {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId   String   @map("tenant_id")
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  action     String
  details    Json?
  createdBy  String?  @map("created_by")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([tenantId], map: "idx_crm_history_tenant")
  @@index([entityType, entityId], map: "idx_crm_history_entity")
  @@index([createdAt(sort: Desc)], map: "idx_crm_history_created_desc")
  @@map("history_logs")
  @@schema("crm")
}

// ── Follow-up configuration (per tenant) ──

model CrmFollowUpConfig {
  id                    String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId              String   @unique @map("tenant_id")
  firstFollowUpDays     Int      @default(3) @map("first_followup_days")
  secondFollowUpDays    Int      @default(7) @map("second_followup_days")
  firstEmailTemplateId  String?  @map("first_email_template_id") @db.Uuid
  secondEmailTemplateId String?  @map("second_email_template_id") @db.Uuid
  whatsappFirstEnabled  Boolean  @default(true) @map("whatsapp_first_enabled")
  whatsappSecondEnabled Boolean  @default(true) @map("whatsapp_second_enabled")
  autoAdvanceStage      Boolean  @default(true) @map("auto_advance_stage")
  pauseOnReply          Boolean  @default(true) @map("pause_on_reply")
  sendHour              Int      @default(9) @map("send_hour") // 0-23, hora local de envío
  isActive              Boolean  @default(true) @map("is_active")
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([tenantId], map: "idx_crm_followup_config_tenant")
  @@map("crm_followup_config")
  @@schema("crm")
}

model CrmFollowUpLog {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String    @map("tenant_id")
  dealId        String    @map("deal_id") @db.Uuid
  sequence      Int       // 1 = primer seguimiento, 2 = segundo
  status        String    @default("pending") // pending, sent, failed, cancelled, paused
  scheduledAt   DateTime  @map("scheduled_at") @db.Timestamptz(6)
  sentAt        DateTime? @map("sent_at") @db.Timestamptz(6)
  emailMessageId String?  @map("email_message_id") @db.Uuid
  templateId    String?   @map("template_id") @db.Uuid
  error         String?
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  deal CrmDeal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([tenantId, status], map: "idx_crm_followup_logs_tenant_status")
  @@index([scheduledAt], map: "idx_crm_followup_logs_scheduled")
  @@index([dealId], map: "idx_crm_followup_logs_deal")
  @@map("crm_followup_logs")
  @@schema("crm")
}

// ── WhatsApp Templates (per tenant, editable messages) ──

model CrmWhatsAppTemplate {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  slug      String   // "lead_commercial", "lead_client", "proposal_sent", "followup_first", "followup_second"
  name      String   // Human-readable label
  body      String   @db.Text // Template body with {token} placeholders
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, slug], map: "uq_crm_wa_template_tenant_slug")
  @@index([tenantId], map: "idx_crm_wa_templates_tenant")
  @@map("crm_whatsapp_templates")
  @@schema("crm")
}

// ── Email Signatures ──

model CrmEmailSignature {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id")
  userId      String?  @map("user_id")
  name        String
  content     Json     @db.JsonB // Tiptap JSON
  htmlContent String?  @map("html_content") // HTML renderizado para emails
  isDefault   Boolean  @default(false) @map("is_default")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([tenantId], map: "idx_crm_signatures_tenant")
  @@index([userId], map: "idx_crm_signatures_user")
  @@index([tenantId, isDefault], map: "idx_crm_signatures_default")
  @@map("email_signatures")
  @@schema("crm")
}

// ============================================
// DOCS MODULE (Document Management System)
// ============================================

model DocCategory {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id")
  module    String   // "crm", "payroll", "legal", "mail"
  key       String   // "contrato_servicio", "email_seguimiento", etc.
  label     String
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, module, key], map: "uq_doc_category_tenant_module_key")
  @@index([tenantId], map: "idx_doc_categories_tenant")
  @@index([tenantId, module], map: "idx_doc_categories_tenant_module")
  @@map("doc_categories")
  @@schema("docs")
}

model DocTemplate {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id")
  name        String
  description String?
  content     Json     @db.JsonB   // Tiptap JSON document
  module      String               // "crm", "payroll", "legal", "mail", "whatsapp"
  category    String               // e.g. "contrato_servicio", "proposal_sent", "general"
  tokensUsed  Json?    @db.JsonB   // ["account.name", "contact.firstName", ...]
  isActive    Boolean  @default(true) @map("is_active")
  isDefault   Boolean  @default(false) @map("is_default")
  /// Si module=whatsapp: slug de uso del sistema (proposal_sent, followup_first, ...). Null = plantilla personalizada para elegir desde CRM.
  usageSlug   String?  @map("usage_slug")
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  versions  DocTemplateVersion[]
  documents Document[]

  @@unique([tenantId, module, name], map: "uq_doc_template_tenant_module_name")
  @@unique([tenantId, usageSlug], map: "uq_doc_template_tenant_usage_slug")
  @@index([tenantId], map: "idx_doc_templates_tenant")
  @@index([module], map: "idx_doc_templates_module")
  @@index([isActive], map: "idx_doc_templates_active")
  @@index([tenantId, module], map: "idx_doc_templates_tenant_module")
  @@map("doc_templates")
  @@schema("docs")
}

model DocTemplateVersion {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  templateId String   @map("template_id") @db.Uuid
  version    Int
  content    Json     @db.JsonB
  changeNote String?  @map("change_note")
  createdBy  String   @map("created_by")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  template DocTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, version], map: "uq_doc_template_version")
  @@index([templateId], map: "idx_doc_template_versions_template")
  @@map("doc_template_versions")
  @@schema("docs")
}

model Document {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String    @map("tenant_id")
  uniqueId        String    @unique @default(cuid())
  templateId      String?   @map("template_id") @db.Uuid
  title           String
  content         Json      @db.JsonB      // Tiptap JSON con tokens resueltos
  tokenValues     Json?     @map("token_values") @db.JsonB
  module          String                    // "crm", "payroll", "legal"
  category        String                    // "contrato_servicio", "contrato_laboral"
  status          String    @default("draft") // draft, review, approved, active, expiring, expired, renewed
  effectiveDate   DateTime? @map("effective_date") @db.Date
  expirationDate  DateTime? @map("expiration_date") @db.Date
  renewalDate     DateTime? @map("renewal_date") @db.Date
  alertDaysBefore Int       @default(30) @map("alert_days_before")
  signatureStatus String?   @map("signature_status")
  signedAt        DateTime? @map("signed_at") @db.Timestamptz(6)
  signedBy        String?   @map("signed_by")
  signatureData   Json?     @map("signature_data") @db.JsonB
  pdfUrl          String?   @map("pdf_url")
  pdfGeneratedAt  DateTime? @map("pdf_generated_at") @db.Timestamptz(6)
  createdBy       String    @map("created_by")
  approvedBy      String?   @map("approved_by")
  approvedAt      DateTime? @map("approved_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  template     DocTemplate?    @relation(fields: [templateId], references: [id], onDelete: SetNull)
  associations DocAssociation[]
  history      DocHistory[]

  @@index([tenantId], map: "idx_documents_tenant")
  @@index([tenantId, module], map: "idx_documents_tenant_module")
  @@index([tenantId, status], map: "idx_documents_tenant_status")
  @@index([expirationDate], map: "idx_documents_expiration")
  @@index([uniqueId], map: "idx_documents_unique_id")
  @@map("documents")
  @@schema("docs")
}

model DocAssociation {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  documentId String   @map("document_id") @db.Uuid
  entityType String   @map("entity_type") // "crm_account", "crm_deal", "crm_installation", "crm_contact"
  entityId   String   @map("entity_id") @db.Uuid
  role       String   @default("primary")  // "primary", "related", "copy"
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, entityType, entityId], map: "uq_doc_association")
  @@index([entityType, entityId], map: "idx_doc_associations_entity")
  @@index([documentId], map: "idx_doc_associations_document")
  @@map("doc_associations")
  @@schema("docs")
}

model DocHistory {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  documentId String   @map("document_id") @db.Uuid
  action     String   // "created", "edited", "status_changed", "signed", "pdf_generated"
  details    Json?    @db.JsonB
  createdBy  String   @map("created_by")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId], map: "idx_doc_history_document")
  @@index([createdAt(sort: Desc)], map: "idx_doc_history_created_desc")
  @@map("doc_history")
  @@schema("docs")
}
